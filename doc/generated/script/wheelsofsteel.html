<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>wheelsofsteel.js</title>
  <style type="text/css">
/**
 * http://jashkenas.github.com/docco/resources/docco.css
 */

/*--------------------- Layout and Typography ----------------------------*/
body {
  font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, FreeSerif, serif;
  font-size: 15px;
  line-height: 22px;
  color: #252519;
  margin: 0; padding: 0;
}
a {
  color: #261a3b;
}
  a:visited {
    color: #261a3b;
  }
p {
  margin: 0 0 15px 0;
}
h1, h2, h3, h4, h5, h6 {
  margin: 0px 0 15px 0;
}
  h1 {
    margin-top: 40px;
  }
#container {
  position: relative;
}
#background {
  position: fixed;
  top: 0; left: 525px; right: 0; bottom: 0;
  background: #f5f5ff;
  border-left: 1px solid #e5e5ee;
  z-index: -1;
}
#jump_to, #jump_page {
  background: white;
  -webkit-box-shadow: 0 0 25px #777; -moz-box-shadow: 0 0 25px #777;
  -webkit-border-bottom-left-radius: 5px; -moz-border-radius-bottomleft: 5px;
  font: 10px Arial;
  text-transform: uppercase;
  cursor: pointer;
  text-align: right;
}
#jump_to, #jump_wrapper {
  position: fixed;
  right: 0; top: 0;
  padding: 5px 10px;
}
  #jump_wrapper {
    padding: 0;
    display: none;
  }
    #jump_to:hover #jump_wrapper {
      display: block;
    }
    #jump_page {
      padding: 5px 0 3px;
      margin: 0 0 25px 25px;
    }
      #jump_page .source {
        display: block;
        padding: 5px 10px;
        text-decoration: none;
        border-top: 1px solid #eee;
      }
        #jump_page .source:hover {
          background: #f5f5ff;
        }
        #jump_page .source:first-child {
        }
table td {
  border: 0;
  outline: 0;
}
  td.docs, th.docs {
    max-width: 450px;
    min-width: 450px;
    min-height: 5px;
    padding: 10px 25px 1px 50px;
    overflow-x: hidden;
    vertical-align: top;
    text-align: left;
  }
    .docs pre {
      margin: 15px 0 15px;
      padding-left: 15px;
    }
    .docs p tt, .docs p code {
      background: #f8f8ff;
      border: 1px solid #dedede;
      font-size: 12px;
      padding: 0 0.2em;
    }
    .pilwrap {
      position: relative;
    }
      .pilcrow {
        font: 12px Arial;
        text-decoration: none;
        color: #454545;
        position: absolute;
        top: 3px; left: -20px;
        padding: 1px 2px;
        opacity: 0;
        -webkit-transition: opacity 0.2s linear;
      }
        td.docs:hover .pilcrow {
          opacity: 1;
        }
  td.code, th.code {
    padding: 14px 15px 16px 25px;
    width: 100%;
    vertical-align: top;
    background: #f5f5ff;
    border-left: 1px solid #e5e5ee;
  }
    pre, tt, code {
      font-size: 12px; line-height: 18px;
      font-family: Menlo, Monaco, Consolas, "Lucida Console", monospace;
      margin: 0; padding: 0;
    }


/*---------------------- Syntax Highlighting -----------------------------*/
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
body .hll { background-color: #ffffcc }
body .c { color: #408080; font-style: italic }  /* Comment */
body .err { border: 1px solid #FF0000 }         /* Error */
body .k { color: #954121 }                      /* Keyword */
body .o { color: #666666 }                      /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 }                     /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 }                     /* Generic.Deleted */
body .ge { font-style: italic }                 /* Generic.Emph */
body .gr { color: #FF0000 }                     /* Generic.Error */
body .gh { color: #000080; font-weight: bold }  /* Generic.Heading */
body .gi { color: #00A000 }                     /* Generic.Inserted */
body .go { color: #808080 }                     /* Generic.Output */
body .gp { color: #000080; font-weight: bold }  /* Generic.Prompt */
body .gs { font-weight: bold }                  /* Generic.Strong */
body .gu { color: #800080; font-weight: bold }  /* Generic.Subheading */
body .gt { color: #0040D0 }                     /* Generic.Traceback */
body .kc { color: #954121 }                     /* Keyword.Constant */
body .kd { color: #954121; font-weight: bold }  /* Keyword.Declaration */
body .kn { color: #954121; font-weight: bold }  /* Keyword.Namespace */
body .kp { color: #954121 }                     /* Keyword.Pseudo */
body .kr { color: #954121; font-weight: bold }  /* Keyword.Reserved */
body .kt { color: #B00040 }                     /* Keyword.Type */
body .m { color: #666666 }                      /* Literal.Number */
body .s { color: #219161 }                      /* Literal.String */
body .na { color: #7D9029 }                     /* Name.Attribute */
body .nb { color: #954121 }                     /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold }  /* Name.Class */
body .no { color: #880000 }                     /* Name.Constant */
body .nd { color: #AA22FF }                     /* Name.Decorator */
body .ni { color: #999999; font-weight: bold }  /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold }  /* Name.Exception */
body .nf { color: #0000FF }                     /* Name.Function */
body .nl { color: #A0A000 }                     /* Name.Label */
body .nn { color: #0000FF; font-weight: bold }  /* Name.Namespace */
body .nt { color: #954121; font-weight: bold }  /* Name.Tag */
body .nv { color: #19469D }                     /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold }  /* Operator.Word */
body .w { color: #bbbbbb }                      /* Text.Whitespace */
body .mf { color: #666666 }                     /* Literal.Number.Float */
body .mh { color: #666666 }                     /* Literal.Number.Hex */
body .mi { color: #666666 }                     /* Literal.Number.Integer */
body .mo { color: #666666 }                     /* Literal.Number.Oct */
body .sb { color: #219161 }                     /* Literal.String.Backtick */
body .sc { color: #219161 }                     /* Literal.String.Char */
body .sd { color: #219161; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #219161 }                     /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold }  /* Literal.String.Escape */
body .sh { color: #219161 }                     /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold }  /* Literal.String.Interpol */
body .sx { color: #954121 }                     /* Literal.String.Other */
body .sr { color: #BB6688 }                     /* Literal.String.Regex */
body .s1 { color: #219161 }                     /* Literal.String.Single */
body .ss { color: #19469D }                     /* Literal.String.Symbol */
body .bp { color: #954121 }                     /* Name.Builtin.Pseudo */
body .vc { color: #19469D }                     /* Name.Variable.Class */
body .vg { color: #19469D }                     /* Name.Variable.Global */
body .vi { color: #19469D }                     /* Name.Variable.Instance */
body .il { color: #666666 }                     /* Literal.Number.Integer.Long */
</style>
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../css/wheelsofsteel.html">wheelsofsteel.css</a>
          <a class="source" href="soundmanager2.html">soundmanager2.js</a>
          <a class="source" href="wheelsofsteel.html">wheelsofsteel.js</a>
          <a class="source" href="../src/SoundManager2_AS3_Flash10.html">SoundManager2_AS3_Flash10.as</a>
          <a class="source" href="../src/SoundManager2_SMSound_AS3_Flash10.html">SoundManager2_SMSound_AS3_Flash10.as</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>wheelsofsteel.js</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-DJ_Schill&amp;rsquo;s_adventures_on_the_wheels_of_steel'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-DJ_Schill&amp;rsquo;s_adventures_on_the_wheels_of_steel">&#182;</a>
        </div>
        <h2>DJ Schill&rsquo;s adventures on the wheels of steel</h2>

<p>A browser-based turntable prototype / toy
(not for serious/skratch DJs given latency etc.)
Code is provided &ldquo;as-is&rdquo;, unsupported and without warranty.</p>

<p>http://wheelsofsteel.net/
http://schillmania.com/content/entries/2011/wheels-of-steel/</p>

<p>HTML + CSS + JS UI, uses SoundManager 2 API
http://schillmania.com/projects/soundmanager2/</p>

<p>Hardware acceleration needed for a usable UI.
Scratch is laggy on Windows due to Flash/OS
latency (and/or I&rsquo;m doing it wrong.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="cm">/* jslint white: false, onevar: false, undef: true, nomen: false, eqeqeq: true, plusplus: false, bitwise: true, regexp: false, newcap: true, immed: true */</span>
<span class="cm">/*global window, turntables, soundManager, console, document, navigator, setTimeout, setInterval, clearInterval, Audio */</span>

<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">){</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>various SM2 config bits</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">soundManager</span><span class="p">.</span><span class="nx">flashVersion</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">useHighPerformance</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">useFastPolling</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">useFlashBlock</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">consoleOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">debugMode</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">useHTML5Audio</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/html5audio/i</span><span class="p">));</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">wmode</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
<span class="nx">soundManager</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;swf/&#39;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>for Chrome, which seems to still return &ldquo;maybe&rdquo; at best.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Test</span> <span class="o">=</span> <span class="sr">/^(probably|maybe)$/i</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>expose a few things to the global, eg., turntables, mixer and so on</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">window</span><span class="p">.</span><span class="nx">wheelsofsteel</span> <span class="o">=</span> <span class="p">{</span>
  <span class="nx">turntables</span><span class="o">:</span> <span class="p">[],</span>
  <span class="nx">mixer</span><span class="o">:</span> <span class="kc">null</span>
<span class="p">};</span>

<span class="kd">var</span> <span class="nx">turntables</span> <span class="o">=</span> <span class="p">[],</span>
    <span class="nx">mixer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
    <span class="nx">utils</span><span class="p">,</span>
    <span class="nx">prefs</span> <span class="o">=</span> <span class="p">{},</span>
    <span class="nx">loc</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
    <span class="nx">isTouchDevice</span> <span class="o">=</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/ipad|ipod|iphone/i</span><span class="p">)),</span> <span class="c1">// this will need future updates</span>
    <span class="nx">IS_SPECIAL_SNOWFLAKE</span> <span class="o">=</span> <span class="nx">isTouchDevice</span><span class="p">,</span> <span class="c1">// iOS has special restrictions on audio.</span>
    <span class="nx">SCRATCH_MODE</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">loc</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/scratch\=1/i</span><span class="p">)),</span> <span class="c1">// or local storage...</span>
    <span class="nx">BATTLE_MODE</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">loc</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/battle/i</span><span class="p">)),</span>
    <span class="nx">STRICT_MODE</span> <span class="o">=</span> <span class="o">!</span><span class="nx">IS_SPECIAL_SNOWFLAKE</span><span class="p">,</span> <span class="c1">// better platter/record physics</span>
    <span class="nx">EMPTY_GIF</span> <span class="o">=</span> <span class="s1">&#39;data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==&#39;</span><span class="p">,</span>
    <span class="nx">add</span><span class="p">,</span>
    <span class="nx">remove</span><span class="p">,</span>
    <span class="nx">soundCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="nx">testDiv</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">),</span>
    <span class="nx">features</span><span class="p">,</span>
    <span class="nx">transform</span><span class="p">,</span>
    <span class="nx">prop</span><span class="p">,</span>
    <span class="nx">styles</span><span class="p">,</span>
    <span class="nx">timer</span><span class="p">,</span>
    <span class="nx">wheelsofsteel</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">wheelsofsteel</span><span class="p">;</span>

<span class="nx">utils</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>events, math and DOM normalization stuffs.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">me</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">DEG2RAD</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">180</span><span class="p">,</span>
      <span class="nx">RAD2DEG</span> <span class="o">=</span> <span class="mi">180</span><span class="o">/</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">,</span>

  <span class="nx">touchEventMap</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;mousedown&#39;</span><span class="o">:</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mousemove&#39;</span><span class="o">:</span> <span class="s1">&#39;touchmove&#39;</span><span class="p">,</span>
    <span class="s1">&#39;mouseup&#39;</span><span class="o">:</span> <span class="s1">&#39;touchend&#39;</span>
  <span class="p">},</span>

  <span class="nx">hasLocalStorage</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>may throw if disabled, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
  <span class="p">}());</span>

  <span class="nx">add</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="nx">evtName</span><span class="p">,</span><span class="nx">evtHandler</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">attachEvent</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="o">+</span><span class="nx">evtName</span><span class="p">,</span><span class="nx">evtHandler</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">remove</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">removeEventListener</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span><span class="nx">evtName</span><span class="p">,</span><span class="nx">evtHandler</span><span class="p">,</span><span class="kc">false</span><span class="p">);</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">o</span><span class="p">.</span><span class="nx">detachEvent</span><span class="p">(</span><span class="s1">&#39;on&#39;</span><span class="o">+</span><span class="nx">evtName</span><span class="p">,</span><span class="nx">evtHandler</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="kd">function</span> <span class="nx">toTouchEvent</span><span class="p">(</span><span class="nx">evtName</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">touchEventMap</span><span class="p">[</span><span class="nx">evtName</span><span class="p">]</span> <span class="o">?</span> <span class="nx">touchEventMap</span><span class="p">[</span><span class="nx">evtName</span><span class="p">]</span> <span class="o">:</span> <span class="nx">evtName</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">add</span><span class="o">:</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">add</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">toTouchEvent</span><span class="p">(</span><span class="nx">evtName</span><span class="p">),</span> <span class="nx">evtHandler</span><span class="p">);</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">add</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">);</span>
    <span class="p">}),</span>

    <span class="nx">remove</span><span class="o">:</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">toTouchEvent</span><span class="p">(</span><span class="nx">evtName</span><span class="p">),</span> <span class="nx">evtHandler</span><span class="p">);</span>
    <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">remove</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">evtName</span><span class="p">,</span> <span class="nx">evtHandler</span><span class="p">);</span>
    <span class="p">})</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">storage</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hasLocalStorage</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">name</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>oh well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">},</span>

    <span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">result</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">hasLocalStorage</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
          <span class="nx">result</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nb">window</span><span class="p">.</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">));</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>oh well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">deg2rad</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nDeg</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">nDeg</span> <span class="o">*</span> <span class="nx">DEG2RAD</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">rad2deg</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nRad</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">nRad</span> <span class="o">*</span> <span class="nx">RAD2DEG</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">findXY</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">curleft</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">curtop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="nx">curleft</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">;</span>
      <span class="nx">curtop</span> <span class="o">+=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">offsetTop</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!!</span><span class="p">(</span><span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">offsetParent</span><span class="p">));</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">curleft</span><span class="p">,</span><span class="nx">curtop</span><span class="p">];</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getMouse</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">sXOrY</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>return rotated coordinates, if element has a transform on it (?)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">return</span> <span class="nx">e</span><span class="p">[(</span><span class="nx">sXOrY</span> <span class="o">===</span> <span class="s1">&#39;clientY&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">BATTLE_MODE</span> <span class="o">?</span> <span class="s1">&#39;clientX&#39;</span> <span class="o">:</span> <span class="s1">&#39;clientY&#39;</span><span class="p">)];</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getMouseXY</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>http://www.quirksmode.org/js/events_properties.html</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="o">?</span><span class="nx">e</span><span class="o">:</span><span class="nb">window</span><span class="p">.</span><span class="nx">event</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span><span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span><span class="p">];</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="o">+</span><span class="nx">utils</span><span class="p">.</span><span class="nx">getScrollLeft</span><span class="p">(),</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="o">+</span><span class="nx">utils</span><span class="p">.</span><span class="nx">getScrollTop</span><span class="p">()];</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getScrollLeft</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollLeft</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getScrollTop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">scrollTop</span><span class="o">+</span><span class="nb">document</span><span class="p">.</span><span class="nx">documentElement</span><span class="p">.</span><span class="nx">scrollTop</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">hasClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span><span class="p">)</span><span class="o">!==</span><span class="s1">&#39;undefined&#39;</span><span class="o">?</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;(^|\\s)&#39;</span><span class="o">+</span><span class="nx">cStr</span><span class="o">+</span><span class="s1">&#39;(\\s|$)&#39;</span><span class="p">).</span><span class="nx">test</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span><span class="p">)</span><span class="o">:</span><span class="kc">false</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">addClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span> <span class="o">||</span> <span class="o">!</span><span class="nx">cStr</span> <span class="o">||</span> <span class="nx">me</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">cStr</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">// safety net</span>
    <span class="p">}</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span><span class="o">?</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="nx">cStr</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">removeClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span> <span class="o">||</span> <span class="o">!</span><span class="nx">cStr</span> <span class="o">||</span> <span class="o">!</span><span class="nx">me</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="nx">cStr</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">&#39;( &#39;</span><span class="o">+</span><span class="nx">cStr</span><span class="o">+</span><span class="s1">&#39;)|(&#39;</span><span class="o">+</span><span class="nx">cStr</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">,</span><span class="s1">&#39;g&#39;</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">toggleClass</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">)</span> <span class="p">{</span>

    <span class="p">(</span><span class="nx">me</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">)</span><span class="o">?</span><span class="nx">me</span><span class="p">.</span><span class="nx">removeClass</span><span class="o">:</span><span class="nx">me</span><span class="p">.</span><span class="nx">addClass</span><span class="p">)(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">cStr</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getCoordsForDOM</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">oDOM</span><span class="p">,</span> <span class="nx">oData</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>relative x/y and so forth</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oData</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">xy</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">findXY</span><span class="p">(</span><span class="nx">oDOM</span><span class="p">);</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">oDOM</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">oDOM</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">=</span> <span class="nx">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">=</span> <span class="nx">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">midX</span> <span class="o">=</span> <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">+</span> <span class="p">(</span><span class="nx">oData</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">);</span>
      <span class="nx">oData</span><span class="p">.</span><span class="nx">midY</span> <span class="o">=</span> <span class="nx">oData</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">+</span> <span class="p">(</span><span class="nx">oData</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getAngleForDOM</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">oDOM</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// oDOM = me.dom[something]</span>

    <span class="kd">var</span> <span class="nx">coords</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getMouseXY</span><span class="p">(</span><span class="nx">e</span><span class="p">),</span>
        <span class="nx">x</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">y</span> <span class="o">=</span> <span class="nx">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">deltaX</span> <span class="o">=</span> <span class="nx">x</span> <span class="o">-</span> <span class="nx">oDOM</span><span class="p">.</span><span class="nx">midX</span><span class="p">,</span>
        <span class="nx">deltaY</span> <span class="o">=</span> <span class="nx">y</span> <span class="o">-</span> <span class="nx">oDOM</span><span class="p">.</span><span class="nx">midY</span><span class="p">,</span>
        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">me</span><span class="p">.</span><span class="nx">rad2deg</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">deltaX</span><span class="p">,</span><span class="nx">deltaY</span><span class="p">));</span>

    <span class="k">return</span> <span class="nx">angle</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getURLParams</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sURL</span><span class="p">,</span> <span class="nx">asObject</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">pairs</span> <span class="o">=</span> <span class="nx">sURL</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">),</span>
        <span class="nx">parts</span> <span class="o">=</span> <span class="p">[],</span>
        <span class="nx">object</span> <span class="o">=</span> <span class="p">{},</span>
        <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>find and trim ? on starting query string, if applicable</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">pairs</span><span class="p">.</span><span class="nx">length</span> <span class="o">&amp;&amp;</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="s1">&#39;?&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">pairs</span> <span class="o">=</span> <span class="p">[];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">asObject</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="nx">pairs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">pairs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">);</span> <span class="c1">// name/value</span>
        <span class="nx">object</span><span class="p">[</span><span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
      <span class="p">}</span>
     <span class="k">return</span> <span class="nx">object</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">pairs</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">isSameProtocol</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sURL1</span><span class="p">,</span> <span class="nx">sURL2</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>compare http:// to http://, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">sURL2</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sURL2</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>also, assume OK if sURL1 is a relative path (eg. no protocol)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">return</span> <span class="p">(</span><span class="nx">sURL1</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;http://&#39;</span><span class="p">)</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">sURL1</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sURL1</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)).</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="nx">sURL2</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">sURL2</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)).</span><span class="nx">toLowerCase</span><span class="p">());</span>

  <span class="p">};</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

<span class="p">}());</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>recall scratch mode from preferences</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">prefs</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;prefs&#39;</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">prefs</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">prefs</span><span class="p">.</span><span class="nx">scratchMode</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">loc</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/scratch\=/i</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// ignore if scratch= in URL</span>
  <span class="nx">SCRATCH_MODE</span> <span class="o">=</span> <span class="nx">prefs</span><span class="p">.</span><span class="nx">scratchMode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">IS_SPECIAL_SNOWFLAKE</span> <span class="o">&amp;&amp;</span> <span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>not an iDevice. We presume you have ze Flash, since you need it for scratch mode.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">soundManager</span><span class="p">.</span><span class="nx">useHTML5Audio</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/http/i</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">soundManager</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;swf/soundmanager2_flash10.swf&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">domain</span> <span class="o">===</span> <span class="s1">&#39;localhost&#39;</span> <span class="o">?</span> <span class="s1">&#39;?rnd=&#39;</span><span class="o">+</span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>offline/dev</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">soundManager</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;swf/soundmanager2_flash10.swf?rnd=&#39;</span><span class="o">+</span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span>

<span class="p">}</span>

<span class="nx">timer</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>main animation loop, fps tracking and so forth</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">animInterval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">fpsInterval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">fpsIntervalCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">fpsCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastExec</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Safari on Snow Leopard occasionally fails to load MP3 files. Unbelievably-bad bug. Allegedly fixed as of OS X Lion. https://bugs.webkit.org/show_bug.cgi?id=32159</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">isBrokenHTML5Safari</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/safari/i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/OS X 10_6_([3-9])/i</span><span class="p">)),</span>
      <span class="nx">refreshAnimationFrame</span><span class="p">,</span>
      <span class="nx">requestAnimationFrame</span><span class="p">,</span>
      <span class="nx">refreshAnimationCallback</span><span class="p">,</span>
      <span class="nx">USE_REQUEST_ANIMATION_FRAME</span> <span class="o">=</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">match</span><span class="p">(</span><span class="sr">/raf\=1/i</span><span class="p">));</span> <span class="c1">// add raf=1 in URL to enable useRequestAnimationFrame support.</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">=</span> <span class="mf">29.999</span><span class="p">;</span> <span class="c1">// start optimistically.</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <p>hat tip: paul irish
http://paulirish.com/2011/requestanimationframe-for-smart-animating/
https://gist.github.com/838785</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">requestAnimationFrame</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="k">return</span> <span class="p">(</span>
      <span class="nx">USE_REQUEST_ANIMATION_FRAME</span> <span class="o">?</span> <span class="p">(</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span>       <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">webkitRequestAnimationFrame</span> <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">mozRequestAnimationFrame</span>    <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">oRequestAnimationFrame</span>      <span class="o">||</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">msRequestAnimationFrame</span>     <span class="o">||</span>
        <span class="kc">null</span>
      <span class="p">)</span> <span class="o">:</span> <span class="kc">null</span>
    <span class="p">);</span>
  <span class="p">}());</span>

  <span class="nx">refreshAnimationFrame</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>schedule a UI redraw, the modern browser way.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">refreshAnimationCallback</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="nx">refreshAnimationCallback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="p">(</span><span class="nx">time</span><span class="o">?</span> <span class="nx">time</span> <span class="o">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()),</span>
        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">lastExec</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">delta</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// works out to ~30 fps</span>
      <span class="nx">lastExec</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
      <span class="nx">timer</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>and repeat the process</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">animInterval</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">refreshAnimationFrame</span><span class="p">();</span>
   <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">refreshFPS</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">||</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fpsIntervalCount</span><span class="o">++</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">fpsCount</span><span class="o">/</span><span class="nx">fpsIntervalCount</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">turntables</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">setRPM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">fpsAverage</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">refreshThrottle</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span>
        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">lastExec</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">delta</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// works out to ~30 fps</span>
      <span class="nx">lastExec</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
      <span class="nx">timer</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">turntables</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">refresh</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">||</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fpsCount</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">interval</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">animInterval</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">lastExec</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>depending on browser support, use requsetAnimationFrame or old-skool interval for main UI update.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">USE_REQUEST_ANIMATION_FRAME</span> <span class="o">&amp;&amp;</span> <span class="nx">requestAnimationFrame</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>modern method</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">console</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;timer.start(): using requestAnimationFrame&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nx">method</span> <span class="o">=</span> <span class="nx">refreshAnimationFrame</span><span class="p">;</span>
        <span class="nx">interval</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">/</span><span class="mi">30</span><span class="p">;</span> <span class="c1">// we&#39;d like ~30 fps here.</span>
        <span class="nx">animInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>and start right away</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">method</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>old-skool method</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">method</span> <span class="o">=</span> <span class="nx">refreshThrottle</span><span class="p">;</span>
        <span class="nx">interval</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// aggressive interval, but callback throttled to ~30 fps.</span>
        <span class="nx">animInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">method</span><span class="p">,</span> <span class="nx">interval</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="nx">fpsInterval</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">refreshFPS</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">stop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">animInterval</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">animInterval</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">refreshFPS</span><span class="p">);</span>
      <span class="nx">animInterval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">fpsInterval</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">debugStats</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>display FPS, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">buffer</span><span class="p">,</span>
        <span class="nx">latency</span><span class="p">,</span>
        <span class="nx">ram</span><span class="p">,</span>
        <span class="nx">sound1</span><span class="p">,</span>
        <span class="nx">sound2</span><span class="p">,</span>
        <span class="nx">getLatency</span><span class="p">,</span>
        <span class="nx">badLatency</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="nx">badFrameRate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="nx">goodFrameRate</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
        <span class="nx">latency1</span><span class="p">,</span>
        <span class="nx">latency2</span><span class="p">,</span>
        <span class="nx">bad</span><span class="p">,</span>
        <span class="nx">badLimit</span><span class="p">,</span>
        <span class="nx">scratchWrapper</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>This part is a big ugly mess of array concatenation and ternary checks, but whatever. It&rsquo;s all debug and stats crap. :D</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">scratchWrapper</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;span&#39;</span><span class="o">+</span><span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="o">?</span><span class="s1">&#39; class=&quot;no-scratch-mode&quot;&#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;&gt;&#39;</span><span class="p">,</span><span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_getDynamicSoundLatency</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sound1</span> <span class="o">=</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_getDynamicSoundLatency</span><span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">);</span>
      <span class="nx">sound2</span> <span class="o">=</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_getDynamicSoundLatency</span><span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">);</span>
      <span class="nx">latency1</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">sound1</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">latency2</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">sound2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">bad</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;span class=&quot;high-latency&quot; title=&quot;High latency for this browser/OS combo - likely a Flash/Windows limitation, sorry. :/&quot;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;/span&gt;&#39;</span><span class="p">];</span>
      <span class="nx">latency</span> <span class="o">=</span> <span class="p">(</span><span class="nx">latency1</span> <span class="o">&gt;</span> <span class="nx">badLatency</span> <span class="o">?</span> <span class="nx">bad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">sound1</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;n/a&#39;</span> <span class="o">:</span> <span class="nx">latency1</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">latency1</span> <span class="o">&gt;</span> <span class="nx">badLatency</span> <span class="o">?</span> <span class="nx">bad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">latency2</span> <span class="o">&gt;</span> <span class="nx">badLatency</span> <span class="o">?</span> <span class="nx">bad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">sound2</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;n/a&#39;</span> <span class="o">:</span> <span class="nx">latency2</span> <span class="o">+</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">latency2</span> <span class="o">&gt;</span> <span class="nx">badLatency</span> <span class="o">?</span> <span class="nx">bad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">&amp;&amp;</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_getMemoryUse</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">ram</span> <span class="o">=</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_getMemoryUse</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;control-stats&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">scratchWrapper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
     <span class="s1">&#39;&lt;span class=&quot;scratch-mode&quot;&gt;Scratch mode&#39;</span><span class="p">,</span>
     <span class="s1">&#39; / latency: &#39;</span> <span class="o">+</span> <span class="nx">latency</span><span class="p">,</span>
     <span class="s1">&#39; / &lt;/span&gt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">SCRATCH_MODE</span> <span class="o">?</span> <span class="s1">&#39;&lt;b style=&quot;cursor:help&quot; title=&quot;Scratch mode also includes pitch bending and EQ/filter effects.&quot;&gt;Scratch mode requires 25+ fps, see &quot;more info&quot; for details&lt;/b&gt; / &#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">?</span> <span class="p">(</span><span class="nx">isBrokenHTML5Safari</span> <span class="o">?</span> <span class="s1">&#39;&lt;b class=&quot;warning&quot;&gt;Safari + Snow Leopard has broken HTML5 audio, often fails to load MP3s. :( &lt;a href=&quot;https://bugs.webkit.org/show_bug.cgi?id=32159#c9&quot; class=&quot;exclude&quot;&gt;Bug #32159&lt;/a&gt;. OS X Lion allegedly fixes this. Until then, try Chrome (or Safari on Windows, since it works) or enable flash.&lt;/b&gt; / &#39;</span> <span class="o">:</span> <span class="s1">&#39;&lt;b&gt;Using HTML5 audio, scratch mode not supported&lt;/b&gt; / &#39;</span><span class="p">)</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;fps&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">requestAnimationFrame</span> <span class="o">?</span> <span class="s1">&#39; &lt;span title=&quot;using requestAnimationFrame for UI updates&quot;&gt;(RAF)&lt;/span&gt;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
     <span class="s1">&#39;: &#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">===</span> <span class="mf">29.999</span> <span class="o">?</span> <span class="s1">&#39;n/a&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">&lt;</span> <span class="nx">badFrameRate</span> <span class="o">?</span> <span class="s1">&#39;&lt;span class=&quot;low-framerate&quot; title=&quot;Low framerate, slow and/or no GPU/hardware acceleration. &#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">?</span> <span class="s1">&#39;Try non-scratch mode.&#39;</span> <span class="o">:</span> <span class="s1">&#39;Your browser and/or hardware may be the bottleneck here.&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">+</span> <span class="s1">&#39;&lt;\/span&gt;&#39;</span> <span class="o">:</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span><span class="p">)),</span>
     <span class="s1">&#39;&lt;span class=&quot;scratch-mode&quot;&gt; / ram: &#39;</span> <span class="o">+</span><span class="p">(</span><span class="nx">ram</span><span class="o">/</span><span class="mi">1024</span><span class="o">/</span><span class="mi">1024</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; mb&lt;\/span&gt;&#39;</span> <span class="o">+</span> <span class="nx">scratchWrapper</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
     <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">&amp;&amp;</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">&lt;</span> <span class="nx">badFrameRate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">||</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39; / &lt;b class=&quot;warning&quot;&gt;Bad sound? Try &lt;a href=&quot;?scratch=0&quot; onclick=&quot;window.location.href = wheelsofsteel.getURLState({scratch:0});return false&quot; class=&quot;exclude&quot;&gt;non-scratch mode&lt;/a&gt;. Lack of hardware acceleration (or high load) means high CPU use, which kills audio processing.&lt;\/b&gt;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
     <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span> <span class="o">&amp;&amp;</span> <span class="nx">timer</span><span class="p">.</span><span class="nx">fpsAverage</span> <span class="o">&gt;=</span> <span class="nx">goodFrameRate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">||</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39; / &lt;b class=&quot;highlight&quot;&gt;Looks like you\&#39;re one of the cool kids. Try &lt;a href=&quot;?scratch=1&quot; onclick=&quot;window.location.href = wheelsofsteel.getURLState({scratch:1});return false&quot; class=&quot;exclude&quot;&gt;scratch mode&lt;/a&gt;.&lt;\/b&gt;&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">return</span> <span class="k">this</span><span class="p">;</span>

<span class="p">}());</span>

<span class="kd">function</span> <span class="nx">has</span><span class="p">(</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>test for feature support</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">testDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">prop</span><span class="p">];</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">result</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">prop</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>

<span class="p">}</span>

<span class="nx">features</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">opacity</span><span class="o">:</span> <span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
      <span class="k">try</span> <span class="p">{</span>
        <span class="nx">testDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="s1">&#39;0.5&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}()),</span>

    <span class="nx">transform</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">ie</span><span class="o">:</span>  <span class="nx">has</span><span class="p">(</span><span class="s1">&#39;-ms-transform&#39;</span><span class="p">),</span>
      <span class="nx">moz</span><span class="o">:</span> <span class="nx">has</span><span class="p">(</span><span class="s1">&#39;MozTransform&#39;</span><span class="p">),</span>
      <span class="nx">opera</span><span class="o">:</span> <span class="nx">has</span><span class="p">(</span><span class="s1">&#39;OTransform&#39;</span><span class="p">),</span>
      <span class="nx">webkit</span><span class="o">:</span> <span class="nx">has</span><span class="p">(</span><span class="s1">&#39;webkitTransform&#39;</span><span class="p">),</span>
      <span class="nx">w3</span><span class="o">:</span> <span class="nx">has</span><span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">),</span>
      <span class="nx">prop</span><span class="o">:</span> <span class="kc">null</span> <span class="c1">// the normalized property value</span>
    <span class="p">},</span>

    <span class="nx">rotate</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">has3D</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">prop</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">}</span>

<span class="p">};</span>

<span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">moz</span> <span class="o">||</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">webkit</span> <span class="o">||</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">ie</span> <span class="o">||</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">opera</span> <span class="o">||</span>
  <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">w3</span>
<span class="p">);</span>

<span class="kd">function</span> <span class="nx">attempt</span><span class="p">(</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>

  <span class="k">try</span> <span class="p">{</span>
    <span class="nx">testDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">transform</span><span class="p">]</span> <span class="o">=</span> <span class="nx">style</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>that <em>definitely</em> didn&rsquo;t work.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>if we can read back the style, it should be cool.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">return</span> <span class="o">!!</span><span class="nx">testDiv</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">transform</span><span class="p">];</span>

<span class="p">}</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">prop</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>try to derive the rotate/3D support.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">transform</span> <span class="o">=</span> <span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">prop</span><span class="p">;</span>
  <span class="nx">styles</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">css_2d</span><span class="o">:</span> <span class="s1">&#39;rotate(0deg)&#39;</span><span class="p">,</span>
    <span class="nx">css_3d</span><span class="o">:</span> <span class="s1">&#39;rotate3d(0,0,0,0deg)&#39;</span>
  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">attempt</span><span class="p">(</span><span class="nx">styles</span><span class="p">.</span><span class="nx">css_3d</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">features</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">has3D</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">prop</span> <span class="o">=</span> <span class="s1">&#39;rotate3d&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">attempt</span><span class="p">(</span><span class="nx">styles</span><span class="p">.</span><span class="nx">css_2d</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">prop</span> <span class="o">=</span> <span class="s1">&#39;rotate&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">soundManager</span><span class="p">.</span><span class="nx">_wD</span><span class="p">(</span><span class="s1">&#39;Has 3D rotate: &#39;</span><span class="o">+</span><span class="nx">features</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">has3D</span><span class="p">);</span>

  <span class="nx">features</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">prop</span> <span class="o">=</span> <span class="nx">prop</span><span class="p">;</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Turntable</span><span class="p">(</span><span class="nx">oTT</span><span class="p">,</span> <span class="nx">sURL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-Turntable()'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Turntable()">&#182;</a>
        </div>
        <h2>Turntable()</h2>

<p>Imagine a Technics 1200SL-MK3 turntable, or thereabouts. Might as well target the golden standard. ;)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">,</span>
      <span class="nx">drag_timer</span><span class="p">,</span>
      <span class="nx">canvas</span><span class="p">,</span>
      <span class="nx">events</span><span class="p">,</span>
      <span class="nx">sound</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">oTT</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Turntable(): Missing or invalid turntable DOM node&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sURL</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>if not provided, play silence.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">sURL</span> <span class="o">=</span> <span class="s1">&#39;audio/null.mp3&#39;</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">qs</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="nx">selector</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">power</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">table</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="nx">motor</span><span class="o">:</span> <span class="kc">false</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">table</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">,</span>
    <span class="nx">wrapper</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.record&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">artImage</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.record-ui&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">record</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.record-ui&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="c1">// good enough, for now</span>
    <span class="nx">cover</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.cover&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">loader</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.loader&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">platter</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.ring&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">startStop</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.startstop&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">powerDial</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.powerdial&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">powerDialLED</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.powerdial-led&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">pitchSlider</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.pitch-slider&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">pitchSliderWrapper</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.pitch&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">pitchSliderInput</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.control-pitch-slider-input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">pitchSliderText</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.control-pitch-slider-text&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">tonearm</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.tonearm&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">tonearmImage</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.tonearm-image&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">compactPlayhead</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.playhead-arrow.compact&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">waveform</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.waveform-1&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">waveform2</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.waveform-2&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">waveformBox</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.waveform&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">waveformImage</span><span class="o">:</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Image</span><span class="p">(),</span>
    <span class="nx">rpm33</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.rpm-33&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
    <span class="nx">rpm45</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.rpm-45&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderText</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderText</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createTextNode</span><span class="p">(</span><span class="s1">&#39;± 0%&#39;</span><span class="p">));</span> <span class="c1">// node, actually</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>internal state and configuration stuffs</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">id</span><span class="o">:</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>

    <span class="nx">force_refresh</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// one-time override for refresh method</span>

    <span class="nx">css</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">dragging</span><span class="o">:</span> <span class="s1">&#39;is_dragging&#39;</span><span class="p">,</span>
      <span class="nx">hasRecord</span><span class="o">:</span> <span class="s1">&#39;has_record&#39;</span>
    <span class="p">},</span>

    <span class="nx">sound</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">blockSize</span><span class="o">:</span> <span class="mi">2048</span><span class="p">,</span> <span class="c1">// the default (for Flash)</span>
      <span class="nx">soundObject</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">eorSounds</span><span class="o">:</span> <span class="p">[],</span> <span class="c1">// &quot;end of record&quot; noises</span>
      <span class="nx">eorSound</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">nextPosition</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">channels</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">gain</span><span class="o">:</span> <span class="mi">1</span>
    <span class="p">},</span>

    <span class="nx">platter</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">angle</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>        <span class="c1">// relative amount of velocity (1 = 100% = 33 RPM?)</span>
      <span class="nx">nudging</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>     <span class="c1">// not scratching, but friction - ie., a thumb weighing down the speed (or pushing it)</span>
      <span class="nx">nudgeDirection</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// which way the &quot;drag&quot; effect goes</span>
      <span class="nx">lastPitchValue</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">// for handling drag events</span>
      <span class="nx">rpmButton</span><span class="o">:</span> <span class="mi">33</span><span class="p">,</span>      <span class="c1">// the default</span>
      <span class="nx">rpm</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>          <span class="c1">// ultimately determined by FPS</span>
      <span class="nx">rpmDelta</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>        <span class="c1">// ratio eg. 33/33 or 45/33</span>
      <span class="nx">locked</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>      <span class="c1">// when false, record speed will always match platter.</span>
      <span class="nx">pitchDelta</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>      <span class="c1">// percentage to adjust velocity by</span>
      <span class="nx">motionScale</span><span class="o">:</span> <span class="mi">5</span><span class="p">,</span>
      <span class="nx">shortBrakeMultiplier</span><span class="o">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="c1">// regular &quot;stop-start&quot; case</span>
      <span class="nx">longBrakeMultiplier</span><span class="o">:</span> <span class="mf">0.98</span><span class="p">,</span> <span class="c1">// power turned off while playing, etc.</span>
      <span class="nx">powerUpMultiplier</span><span class="o">:</span> <span class="mf">1.5</span><span class="p">,</span>
      <span class="nx">powerLEDFlicker</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">imageURL</span><span class="o">:</span> <span class="kc">null</span>      <span class="c1">// album art?</span>
    <span class="p">},</span>

    <span class="nx">power</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">table</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">motor</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">},</span>

    <span class="nx">record</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">angle</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">angleOffset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">dragging</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">mouseMoveCount</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastMouseMove</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>     <span class="c1">// timestamp</span>
      <span class="nx">rotations</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1">// how many times the record has actually turned</span>
      <span class="nx">rotationsAtMouseDown</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// for when grabbing/scratching, need to track relative movement</span>
      <span class="nx">draggedAngle</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>         <span class="c1">// relative movement</span>
      <span class="nx">angleAtMouseDown</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastDelta</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">positionAtMouseDown</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1">// record sound position at the time</span>
      <span class="nx">rotationsSinceMouseDown</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">cuePoints</span><span class="o">:</span> <span class="p">[],</span>           <span class="c1">// sticky tape!</span>
      <span class="nx">velocity</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>             <span class="c1">// record velocity relative to platter</span>
      <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// points of interest for rotation</span>
      <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">},</span>

    <span class="nx">tonearm</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">angle</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">angleOffset</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">angleToRecord</span><span class="o">:</span> <span class="mi">16</span><span class="p">,</span>
      <span class="nx">angleMax</span><span class="o">:</span> <span class="mi">28</span><span class="p">,</span> <span class="c1">// something around there, anyway.</span>
      <span class="nx">dragging</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">drift</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">driftMax</span><span class="o">:</span> <span class="mf">0.5</span><span class="p">,</span> <span class="c1">// silly fun: how much the tonearm should sway side-to-side while the record spins.</span>
      <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>    <span class="c1">// points of interest for rotation</span>
      <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">},</span>

    <span class="nx">waveform</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">width</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">height</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastMouseX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">lastExec</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">markers</span><span class="o">:</span> <span class="p">[],</span>  <span class="c1">// equivalent to cue points</span>
      <span class="nx">sizeLimit</span><span class="o">:</span> <span class="p">(</span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/firefox/i</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32767</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">),</span> <span class="c1">// Firefox barfs on PNGs bigger than 32K pixels on any side - meanwhile, &quot;64K ought to be enough for anyone [else] :D&quot;</span>
      <span class="nx">xOffset</span><span class="o">:</span> <span class="mi">250</span><span class="p">,</span> <span class="c1">// half of the container</span>
      <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">},</span>

    <span class="nx">pitchSlider</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">lastOffsetY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">lastY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">mouseOffsetY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">minY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">maxY</span><span class="o">:</span> <span class="mi">999</span>
    <span class="p">},</span>

    <span class="nx">playhead</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">lastX</span><span class="o">:</span> <span class="mi">0</span>
    <span class="p">},</span>

    <span class="nx">pending</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// throttled data, applied at intervals</span>
      <span class="nx">pitch</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">power</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">power</span><span class="p">;</span> <span class="c1">// convenience</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setAngle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">features</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">has3D</span> <span class="o">?</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">nAngle</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rotate3d(0,0,0,&#39;</span><span class="o">+</span><span class="nx">nAngle</span><span class="o">+</span><span class="s1">&#39;deg)&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">nAngle</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">style</span><span class="p">[</span><span class="nx">features</span><span class="p">.</span><span class="nx">transform</span><span class="p">.</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;rotate(&#39;</span><span class="o">+</span><span class="nx">nAngle</span><span class="o">+</span><span class="s1">&#39;deg)&#39;</span><span class="p">;</span>
  <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-36'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-36">&#182;</a>
        </div>
        <p>edge case&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">features</span><span class="p">.</span><span class="nx">rotate</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">lastRotateExec</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">,</span>
        <span class="nx">r</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>move relative to own velocity, or lock to platter velocity</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">r</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">STRICT_MODE</span> <span class="o">?</span> <span class="nx">r</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">*</span> <span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span> <span class="o">:</span> <span class="nx">p</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">*</span> <span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">angle</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">r</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-=</span> <span class="mi">360</span><span class="p">;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotations</span><span class="o">++</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">r</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>

        <span class="nx">r</span><span class="p">.</span><span class="nx">rotations</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">rotations</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>

      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">applyDrift</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>the platter should rotate, but not the record (if being held/dragged.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">,</span> <span class="nx">r</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">STRICT_MODE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">velocity</span><span class="o">*</span><span class="mf">0.025</span><span class="p">)</span><span class="o">*</span><span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        <p>platter always(?) spins.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">velocity</span><span class="o">*</span><span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">-=</span> <span class="mi">360</span><span class="p">;</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">platter</span><span class="p">,</span> <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">p</span><span class="p">.</span><span class="nx">powerLEDFlicker</span> <span class="o">=</span> <span class="o">!</span><span class="nx">p</span><span class="p">.</span><span class="nx">powerLEDFlicker</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">powerDialLED</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">powerLEDFlicker</span> <span class="o">?</span> <span class="mf">0.85</span> <span class="o">:</span> <span class="mf">0.9</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">r</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>check record vs. platter velocity</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>adjust audio rate to match?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">originalDiff</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocityOffset</span><span class="p">,</span>
            <span class="nx">diff</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">,</span>
            <span class="nx">absDiff</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">diff</span><span class="p">),</span>
            <span class="nx">absVelocity</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">),</span>
            <span class="nx">absDiffScaled</span> <span class="o">=</span> <span class="nx">absDiff</span><span class="o">*</span><span class="mf">0.25</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>handle differently if the platter is not moving.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">absDiff</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// record needs to speed up</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">absDiff</span> <span class="o">*</span> <span class="mf">0.125</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// record needs to slow down</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">-=</span> <span class="p">(</span><span class="nx">absDiff</span> <span class="o">*</span> <span class="mf">0.125</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>equilibrium has been reached.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        <p>and the platter should still move a percentage, due to friction.
this is a hack.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="k">if</span> <span class="p">(</span><span class="nx">STRICT_MODE</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">p</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">velocity</span><span class="o">*</span><span class="mf">0.025</span><span class="p">)</span><span class="o">*</span><span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>apply velocity to sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>friction/acceleration hack: speed up a lot if the platter is moving, and the record is near 0.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">absDiffScaled</span> <span class="o">=</span> <span class="nx">absDiff</span><span class="o">*</span><span class="mf">0.75</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">absDiff</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">diff</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// record needs to speed up</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">+=</span> <span class="nx">absDiffScaled</span> <span class="o">*</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mf">0.5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// if moving backwards, compensate for forward record movement by scaling down diff.</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// record needs to slow down</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">-=</span> <span class="nx">absDiffScaled</span><span class="p">;</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>equilibrium has been reached.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">;</span>
          <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>apply velocity to sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">updateWaveform</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePlayhead</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>throttled calls here&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">lastRotateExec</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudging</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">applyPlatterNudge</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pending</span><span class="p">.</span><span class="nx">pitch</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">();</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pending</span><span class="p">.</span><span class="nx">pitch</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">lastRotateExec</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">updatePlayhead</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">offX</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">position</span><span class="o">/</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">// TODO: Fix hardcoded 500 value</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">offX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">playhead</span><span class="p">.</span><span class="nx">lastX</span> <span class="o">!==</span> <span class="nx">offX</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-50'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-50">&#182;</a>
        </div>
        <p>move small playhead in scope of total</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">compactPlayhead</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">offX</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">playhead</span><span class="p">.</span><span class="nx">lastX</span> <span class="o">=</span> <span class="nx">offX</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">updateWaveform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-51'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-51">&#182;</a>
        </div>
        <p>update the waveform box to the current position, too&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">waveX</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">width</span><span class="o">*</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">position</span><span class="o">/</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">)));</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">waveX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">waveX</span> <span class="o">!==</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">lastX</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundPosition</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">xOffset</span><span class="o">+</span><span class="nx">waveX</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;px 0px&#39;</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">lastX</span> <span class="o">=</span> <span class="nx">waveX</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">unloadWaveform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">loadWaveform</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">trackName</span><span class="p">,</span> <span class="nx">soundcloudID</span><span class="p">,</span> <span class="nx">soundcloudURL</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">fgcolor</span> <span class="o">=</span> <span class="s1">&#39;336699&#39;</span><span class="p">,</span> <span class="c1">// color to draw the waveform with</span>
        <span class="nx">defaultWidth</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
        <span class="nx">defaultHeight</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
        <span class="nx">compactHeight</span> <span class="o">=</span> <span class="mi">88</span><span class="p">,</span> <span class="c1">// cheat and artificially compensate for low-contrast peaks</span>

    <span class="nx">waveformURL</span> <span class="o">=</span> <span class="s1">&#39;utils/waveform/?&#39;</span> <span class="o">+</span> <span class="p">[</span>
      <span class="s1">&#39;track=&#39;</span> <span class="o">+</span> <span class="nx">trackName</span><span class="p">,</span>
      <span class="s1">&#39;width=&#39;</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">sizeLimit</span><span class="p">,</span> <span class="c1">// several minutes will fit within the 64K-pixel limit; longer tracks will start to get scaled down.</span>
      <span class="s1">&#39;height=&#39;</span> <span class="o">+</span> <span class="nx">defaultHeight</span><span class="p">,</span>
      <span class="s1">&#39;fgcolor=&#39;</span> <span class="o">+</span> <span class="nx">fgcolor</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">),</span>

    <span class="nx">compactWaveformURL</span> <span class="o">=</span> <span class="s1">&#39;utils/waveform/?&#39;</span> <span class="o">+</span> <span class="p">[</span>
      <span class="s1">&#39;track=&#39;</span> <span class="o">+</span> <span class="nx">trackName</span><span class="p">,</span>
      <span class="s1">&#39;width=&#39;</span> <span class="o">+</span> <span class="nx">defaultWidth</span><span class="p">,</span>
      <span class="s1">&#39;height=&#39;</span> <span class="o">+</span> <span class="nx">compactHeight</span><span class="p">,</span>
      <span class="s1">&#39;fgcolor=&#39;</span> <span class="o">+</span> <span class="nx">fgcolor</span>
    <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">resetImage</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">;</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">);</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">img</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>unload with a 1x1 .gif.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">EMPTY_GIF</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/http/i</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>offline case</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">waveformURL</span> <span class="o">=</span> <span class="s1">&#39;utils/waveform/cache/&#39;</span> <span class="o">+</span> <span class="p">[</span>
        <span class="nx">trackName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span> <span class="c1">// space to underscore in cached file names</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">sizeLimit</span> <span class="o">+</span> <span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nx">defaultHeight</span><span class="p">,</span> <span class="c1">// several minutes will fit within the 64K-pixel limit; longer tracks will start to get scaled down.</span>
        <span class="s1">&#39;transparent&#39;</span><span class="p">,</span>
        <span class="nx">fgcolor</span>
      <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">;</span>

      <span class="nx">compactWaveformURL</span> <span class="o">=</span> <span class="s1">&#39;utils/waveform/cache/&#39;</span> <span class="o">+</span> <span class="p">[</span>
        <span class="nx">trackName</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;x&#39;</span><span class="o">+</span><span class="nx">compactHeight</span><span class="p">,</span> <span class="c1">// +2 for padding/border stuff, thus 498 becomes 500.</span>
        <span class="s1">&#39;transparent&#39;</span><span class="p">,</span>
        <span class="nx">fgcolor</span>
      <span class="p">].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">;</span>

    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>soundcloud hax</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">soundcloudID</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">waveformURL</span> <span class="o">=</span> <span class="nx">soundcloudURL</span><span class="p">;</span> 
      <span class="nx">compactWaveformURL</span> <span class="o">=</span> <span class="nx">soundcloudURL</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\_m/</span><span class="p">,</span> <span class="s1">&#39;_s&#39;</span><span class="p">);</span> <span class="c1">// 600px variant</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformImage</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">waveformURL</span><span class="p">)</span> <span class="o">!==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-55'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-55">&#182;</a>
        </div>
        <p>we&rsquo;re there, dude.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformImage</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">bgURL</span> <span class="o">=</span> <span class="s1">&#39;transparent url(&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">src</span><span class="o">+</span><span class="s1">&#39;) no-repeat &#39;</span><span class="o">+</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">xOffset</span><span class="o">+</span><span class="s1">&#39;px 0px&#39;</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="nx">bgURL</span><span class="p">;</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">);</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">,</span> <span class="s1">&#39;loaded&#39;</span><span class="p">);</span>
      <span class="nx">resetImage</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformImage</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">resetImage</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>zoomed-out, full-width dealio</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent url(&#39;</span><span class="o">+</span><span class="nx">compactWaveformURL</span><span class="o">+</span><span class="s1">&#39;) no-repeat 0px 50%&#39;</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformImage</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">waveformURL</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyDrift</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">recordAngle</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">drift</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">utils</span><span class="p">.</span><span class="nx">deg2rad</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angle</span><span class="p">))</span><span class="o">*</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">driftMax</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">moveTonearm</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">oOptions</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span>
        <span class="nx">angle</span><span class="p">,</span>
        <span class="nx">drift</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">drift</span><span class="p">,</span>
        <span class="nx">relativeAngle</span> <span class="o">=</span> <span class="p">(</span><span class="nx">oOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">relativeAngle</span> <span class="o">?</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">relativeAngle</span> <span class="o">:</span> <span class="kc">null</span><span class="p">),</span>
        <span class="nx">position</span> <span class="o">=</span> <span class="p">(</span><span class="nx">oOptions</span> <span class="o">&amp;&amp;</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">position</span><span class="o">?</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">position</span> <span class="o">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">relativeAngle</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">angle</span> <span class="o">=</span> <span class="nx">relativeAngle</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// sound.playState &amp;&amp;</span>
      <span class="nx">angle</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span> <span class="o">+</span> <span class="nx">drift</span> <span class="o">+</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleMax</span> <span class="o">*</span> <span class="p">(</span><span class="nx">position</span><span class="o">/</span><span class="nx">sound</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">angle</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">angle</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// todo: fix bug: when mousedown() fires followed by no mousemove() during redraw, angle is undefined / NaN</span></pre></div>
      </td>
    </tr>
    <tr id='section-57'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-57">&#182;</a>
        </div>
        <p>a little hackish: restrict movement again.
check for weird angles &ndash; user not clicking on cartridge/needle assembly, but top of tonearm area etc. bad action.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleMax</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">driftMax</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">angle</span><span class="p">));</span> <span class="c1">// hack: 9 degrees ~= label radius</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">angle</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">angle</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setRPM</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">averageFPS</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-58'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-58">&#182;</a>
        </div>
        <p>based on framerate and angle per frame, determine RPM average.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">p</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">,</span>
        <span class="nx">averageAnglePerMinute</span> <span class="o">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">velocity</span><span class="o">*</span><span class="nx">p</span><span class="p">.</span><span class="nx">motionScale</span><span class="o">*</span><span class="nx">averageFPS</span><span class="p">)</span><span class="o">*</span><span class="mi">60</span><span class="p">,</span>
        <span class="nx">averageRPM</span> <span class="o">=</span> <span class="nx">averageAnglePerMinute</span><span class="o">/</span><span class="mi">360</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-59'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-59">&#182;</a>
        </div>
        <p>console.log(&lsquo;average RPM: &rsquo;+averageRPM);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">rpm</span> <span class="o">=</span> <span class="nx">averageRPM</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setRPMClick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">),</span>
        <span class="nx">rpm</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">substr</span><span class="p">(</span><span class="nx">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">setButtonRPM</span><span class="p">(</span><span class="nx">rpm</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">applyRPM</span><span class="p">(</span><span class="nx">rpm</span><span class="p">);</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyRPM</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">rpm</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">velocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getPlatterVelocity</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">rpmDelta</span> <span class="o">=</span> <span class="nx">rpm</span><span class="o">/</span><span class="mi">33</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">recordMouseDown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-60'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-60">&#182;</a>
        </div>
        <p>get midpoint, figure out relative angle, move by that</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getAngleForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">angle</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">lastTravelDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleAtMouseDown</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angle</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotationsAtMouseDown</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotations</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">positionAtMouseDown</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">position</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleOffset</span> <span class="o">=</span> <span class="nx">angle</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleOffset</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleOffset</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-61'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-61">&#182;</a>
        </div>
        <p>attach events</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseUp</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">dragging</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-62'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-62">&#182;</a>
        </div>
        <p>pause while dragging</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">mouseMoveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// reset counter...</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseMove</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">normalizeAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">+=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">a</span> <span class="o">&gt;</span> <span class="mi">360</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">a</span> <span class="o">-=</span> <span class="mi">360</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pitchMouseDown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-63'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-63">&#182;</a>
        </div>
        <p>watch for mousemove()</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-64'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-64">&#182;</a>
        </div>
        <p>set limits, too</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">midHeight</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">minY</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">midHeight</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderWrapper</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-65'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-65">&#182;</a>
        </div>
        <p>do the offset thingy</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">lastY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">minY</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">lastOffsetY</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">findXY</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">mouseOffsetY</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;clientY&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">lastOffsetY</span><span class="p">;</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseUp</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pitchMouseMove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
        <span class="nx">mouseScale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1">// how far to move relative to mouse</span>
        <span class="nx">sliderY</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">lastY</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="nx">utils</span><span class="p">.</span><span class="nx">getMouse</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="s1">&#39;clientY&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">lastOffsetY</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">mouseOffsetY</span><span class="p">)</span> <span class="o">*</span> <span class="nx">mouseScale</span> <span class="p">),</span>
        <span class="nx">pitchPosition</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">((</span><span class="nx">sliderY</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">midHeight</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="mi">3</span><span class="p">)))),</span> <span class="c1">// minus a few pixels for maxY limit</span>
        <span class="nx">pitchValue</span><span class="p">,</span>
        <span class="nx">pitchMax</span> <span class="o">=</span> <span class="mf">0.08</span><span class="p">,</span>
        <span class="nx">sliderMidpoint</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="nx">sliderInputValue</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">sliderY</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">minY</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">midHeight</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">sliderY</span><span class="p">));</span> <span class="c1">// enforce limits</span></pre></div>
      </td>
    </tr>
    <tr id='section-66'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-66">&#182;</a>
        </div>
        <p>set position</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">sliderY</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>

    <span class="nx">sliderInputValue</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pitchPosition</span> <span class="o">*</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-67'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-67">&#182;</a>
        </div>
        <p>update underlying node</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">sliderInputValue</span><span class="p">);</span> <span class="c1">// relative to input&#39;s min/max</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sliderInputValue</span><span class="p">;</span> <span class="c1">// actually updates the UI</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitchThrottled</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">movePitchSliderPerValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-68'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-68">&#182;</a>
        </div>
        <p>position slider to represent given value</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">minY</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">minY</span><span class="p">,</span>
        <span class="nx">maxY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span> <span class="c1">// TODO: eliminate redundant math</span>
        <span class="nx">relPosition</span> <span class="o">=</span> <span class="p">((</span><span class="nx">value</span><span class="o">/</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">))</span> <span class="o">*</span> <span class="nx">maxY</span><span class="p">)</span> <span class="o">/</span> <span class="nx">maxY</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-69'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-69">&#182;</a>
        </div>
        <p>var relPosition = (value / self.dom.pitchSliderInput.getAttribute(&lsquo;max&rsquo;));</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">movePitchSlider</span><span class="p">(</span><span class="nx">relPosition</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">movePitchSlider</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-70'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-70">&#182;</a>
        </div>
        <p>relative move, for things like 0, 50, 100%;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="nx">position</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;%&#39;</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pitchMouseUp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseUp</span><span class="p">);</span>

  <span class="p">};</span>
  
  <span class="k">this</span><span class="p">.</span><span class="nx">updatePitchThrottled</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pending</span><span class="p">.</span><span class="nx">pitch</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">updatePitch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-71'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-71">&#182;</a>
        </div>
        <p>event handler: slider control has changed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">slider</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">,</span>
        <span class="nx">maxUp</span> <span class="o">=</span> <span class="mf">0.08</span><span class="p">,</span> <span class="c1">// 10%</span>
        <span class="nx">maxDown</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.08</span><span class="p">,</span>
        <span class="nx">v</span> <span class="o">=</span> <span class="nx">slider</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span>
        <span class="nx">midpoint</span> <span class="o">=</span> <span class="nx">slider</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
        <span class="nx">pitchDelta</span><span class="p">,</span>
        <span class="nx">pitchString</span><span class="p">,</span>
        <span class="nx">velocity</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">===</span> <span class="nx">midpoint</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pitchDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">v</span> <span class="o">&lt;</span> <span class="nx">midpoint</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">pitchDelta</span> <span class="o">=</span> <span class="nx">maxDown</span> <span class="o">+</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">maxDown</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nx">v</span><span class="o">/</span><span class="nx">midpoint</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">pitchDelta</span> <span class="o">=</span> <span class="p">(</span><span class="nx">maxUp</span><span class="o">*</span><span class="p">((</span><span class="nx">v</span><span class="o">-</span><span class="nx">midpoint</span><span class="p">)</span><span class="o">/</span><span class="nx">midpoint</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nx">pitchString</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pitchDelta</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;± 0&#39;</span> <span class="o">:</span> <span class="p">(</span><span class="nx">pitchDelta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s1">&#39;+&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="nx">pitchDelta</span><span class="o">*</span><span class="mi">100</span><span class="p">).</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">;</span>
    <span class="nx">slider</span><span class="p">.</span><span class="nx">title</span> <span class="o">=</span> <span class="nx">pitchString</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderText</span><span class="p">.</span><span class="nx">nodeValue</span> <span class="o">=</span> <span class="nx">pitchString</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">pitchDelta</span> <span class="o">=</span> <span class="nx">pitchDelta</span><span class="p">;</span>
    <span class="nx">velocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">rpmDelta</span> <span class="o">+</span> <span class="nx">pitchDelta</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-72'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-72">&#182;</a>
        </div>
        <p>update platter velocity..</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-73'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-73">&#182;</a>
        </div>
        <p>and apply to the sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">resetPitch</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-74'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-74">&#182;</a>
        </div>
        <p>event fired from input type=&ldquo;range&rdquo;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">slider</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">,</span>
        <span class="nx">mid</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">slider</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

    <span class="nx">slider</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">mid</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;resetting&#39;</span><span class="p">);</span> <span class="c1">// transition doesn&#39;t work here, for some reason.</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">movePitchSliderPerValue</span><span class="p">(</span><span class="nx">mid</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-75'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-75">&#182;</a>
        </div>
        <p>self.movePitchSlider(0.5); // reset to mid-point</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
     <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;resetting&#39;</span><span class="p">);</span>
    <span class="p">},</span> <span class="mi">250</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getPlatterVelocity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">pitchDelta</span><span class="p">)</span> <span class="o">*</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">rpmDelta</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">recordMouseMove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getAngleForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span> <span class="nx">e</span><span class="p">),</span>
        <span class="nx">sound</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">,</span>
        <span class="nx">record</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span>
        <span class="nx">now</span><span class="p">,</span>
        <span class="nx">displayAngle</span><span class="p">,</span>
        <span class="nx">travelDelta</span><span class="p">,</span>
        <span class="nx">howFarSinceLastMouseMove</span><span class="p">,</span>
        <span class="nx">nextSoundPosition</span><span class="p">,</span>
        <span class="nx">oldRate</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="nx">angle</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">normalizeAngle</span><span class="p">(</span><span class="nx">angle</span><span class="p">);</span>

    <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>

    <span class="nx">displayAngle</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">angleAtMouseDown</span> <span class="o">+</span> <span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleOffset</span><span class="o">-</span><span class="nx">angle</span><span class="p">);</span>

    <span class="nx">displayAngle</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">normalizeAngle</span><span class="p">(</span><span class="nx">displayAngle</span><span class="p">);</span>

    <span class="nx">travelDelta</span> <span class="o">=</span> <span class="nx">record</span><span class="p">.</span><span class="nx">angleAtMouseDown</span> <span class="o">+</span> <span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleOffset</span> <span class="o">-</span> <span class="nx">angle</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-76'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-76">&#182;</a>
        </div>
        <p>if lastTravelDelta is 0 (ie., mouse just went down), don&rsquo;t apply.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">howFarSinceLastMouseMove</span> <span class="o">=</span> <span class="p">(</span><span class="nx">record</span><span class="p">.</span><span class="nx">lastTravelDelta</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="nx">travelDelta</span> <span class="o">-</span> <span class="nx">record</span><span class="p">.</span><span class="nx">lastTravelDelta</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-77'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-77">&#182;</a>
        </div>
        <p>position-based seek, track with record movement</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">nextSoundPosition</span> <span class="o">=</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span> <span class="o">+</span> <span class="p">((</span><span class="nx">howFarSinceLastMouseMove</span><span class="o">/</span><span class="mi">360</span><span class="p">)</span><span class="o">*</span><span class="mi">2000</span><span class="p">);</span> <span class="c1">// ~2 seconds per rotation(?)</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">sound</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">nextSoundPosition</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-78'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-78">&#182;</a>
        </div>
        <p>here&rsquo;s where things get more hacky.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">oldRate</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-79'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-79">&#182;</a>
        </div>
        <p>fake this a little bit.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="nx">howFarSinceLastMouseMove</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span> <span class="c1">// incorporate fpsAverage?</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">drag_timer</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">drag_timer</span><span class="p">);</span>
      <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-80'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-80">&#182;</a>
        </div>
        <p>try to cancel/stop motion within a reasonable delay after the last mouse move &ndash; otherwise, the record will follow the last &ldquo;known&rdquo; speed.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">drag_timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">||</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// or, scratching with power off</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>
          <span class="nx">drag_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-81'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-81">&#182;</a>
        </div>
        <p>stop somewhere between 20 and 150 msec</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">},</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">lastMouseMove</span> <span class="o">?</span> <span class="p">(</span><span class="nx">now</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">lastMouseMove</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)));</span> <span class="c1">// stop next one in 2x the last recorded delta</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">lastMouseMove</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="nx">record</span><span class="p">.</span><span class="nx">lastTravelDelta</span> <span class="o">=</span> <span class="nx">travelDelta</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span> <span class="nx">displayAngle</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">applyDrift</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleDuringMouseMove</span> <span class="o">=</span> <span class="nx">displayAngle</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">mouseMoveCount</span><span class="o">++</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">recordMouseUp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">velocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getPlatterVelocity</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">dragging</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">drag_timer</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">clearTimeout</span><span class="p">(</span><span class="nx">drag_timer</span><span class="p">);</span>
      <span class="nx">drag_timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">||</span> <span class="nx">STRICT_MODE</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">velocity</span><span class="p">);</span>

    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-82'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-82">&#182;</a>
        </div>
        <p>IF not in vinyl &ldquo;STRICT&rdquo; mode (or mouse has hardly moved), don&rsquo;t simulate record/platter friction</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">STRICT_MODE</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">mouseMoveCount</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="nx">velocity</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-83'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-83">&#182;</a>
        </div>
        <p>determine and set new position?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotations</span> <span class="o">+=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotationsSinceMouseDown</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">rotationsSinceMouseDown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angleDuringMouseMove</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-84'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-84">&#182;</a>
        </div>
        <p>apply, resume sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-85'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-85">&#182;</a>
        </div>
        <p>sound.setPosition(sound.nextPosition*sound.durationEstimate);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sound</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">mouseMoveCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// reset</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseUp</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">tonearmMouseDown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">);</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseUp</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearmImage</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">dragging</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-86'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-86">&#182;</a>
        </div>
        <p>stop sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">sound</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getAngleForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">relativeAngle</span> <span class="o">=</span> <span class="nx">angle</span> <span class="o">-</span> <span class="mi">360</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleOffset</span> <span class="o">=</span> <span class="p">(</span><span class="nx">relativeAngle</span><span class="o">-</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-87'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-87">&#182;</a>
        </div>
        <p>move to current position</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseMove</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">tonearmMouseMove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">angle</span> <span class="o">=</span> <span class="mi">360</span> <span class="o">-</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getAngleForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span> <span class="nx">e</span><span class="p">),</span>
        <span class="nx">sound</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">,</span>
        <span class="nx">tonearm</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span>
        <span class="nx">relativeAngle</span> <span class="o">=</span> <span class="nx">angle</span> <span class="o">-</span> <span class="mi">360</span> <span class="o">-</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-88'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-88">&#182;</a>
        </div>
        <p>only let user move within record space..</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">relativeAngle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleMax</span> <span class="o">+</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">relativeAngle</span><span class="p">));</span>

    <span class="nx">sound</span><span class="p">.</span><span class="nx">nextPosition</span> <span class="o">=</span> <span class="p">(</span><span class="nx">relativeAngle</span> <span class="o">-</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span> <span class="o">-</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleOffset</span><span class="p">)</span> <span class="o">/</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleMax</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">({</span>
      <span class="nx">relativeAngle</span><span class="o">:</span> <span class="nx">relativeAngle</span><span class="o">-</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleOffset</span>
    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">tonearmMouseUp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearmImage</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">dragging</span><span class="p">);</span>

    <span class="kd">var</span> <span class="nx">newPosition</span><span class="p">,</span> <span class="nx">tonearm</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-89'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-89">&#182;</a>
        </div>
        <p>apply, resume sound</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">newPosition</span> <span class="o">=</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">nextPosition</span><span class="o">*</span><span class="nx">sound</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">;</span>
      <span class="nx">sound</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">newPosition</span><span class="p">);</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">({</span>
        <span class="nx">relativeAngle</span><span class="o">:</span> <span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleToRecord</span> <span class="o">+</span> <span class="p">(</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">angleMax</span> <span class="o">*</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">nextPosition</span><span class="p">)</span>
      <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-90'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-90">&#182;</a>
        </div>
        <p>cheat and set the new sound position on the object -right now-</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">newPosition</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sound</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseUp</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">unload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-91'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-91">&#182;</a>
        </div>
        <p>remove current album image, waveform etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">unload</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-92'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-92">&#182;</a>
        </div>
        <p>self.data.sound.soundObject.load({url: &lsquo;audio/null.mp3&rsquo;}); // empty sound again?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">hasRecord</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundImage</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">,</span> <span class="s1">&#39;empty&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">background</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-93'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-93">&#182;</a>
        </div>
        <p>utils.removeClass(self.dom.waveformBox, &lsquo;loaded&rsquo;);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">destroyCuePoints</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">waveformBoxMouseDown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseMove</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseUp</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">waveformBoxMouseMove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">((</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetLeft</span><span class="p">)</span> <span class="o">/</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">))),</span>
        <span class="nx">sound</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">,</span>
        <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">(),</span>
        <span class="nx">delta</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">lastExec</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">&amp;&amp;</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">!==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nx">delta</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// throttle calls</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">lastExec</span> <span class="o">=</span> <span class="nx">now</span><span class="p">;</span>
      <span class="nx">sound</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">durationEstimate</span> <span class="o">*</span> <span class="nx">offset</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">updatePlayhead</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">waveformBoxMouseUp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseMove</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">document</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseUp</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">refresh</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">force_refresh</span> <span class="o">||</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="nx">STRICT_MODE</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">dragging</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">.</span><span class="nx">dragging</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">rotate</span><span class="p">();</span> <span class="c1">// move platter</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">();</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">force_refresh</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyRate</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sID</span><span class="p">,</span> <span class="nx">nRate</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_setRate</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">,</span> <span class="nx">nRate</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_setRate</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">.</span><span class="nx">sID</span><span class="p">,</span> <span class="nx">nRate</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setButtonRPM</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nRPM</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s1">&#39;rpm-33&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="s1">&#39;rpm-45&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">nRPM</span> <span class="o">===</span> <span class="mi">45</span> <span class="o">?</span> <span class="s1">&#39;rpm-45&#39;</span> <span class="o">:</span> <span class="s1">&#39;rpm-33&#39;</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">applyRPM</span><span class="p">(</span><span class="nx">nRPM</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setPower</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">pClass</span> <span class="o">=</span> <span class="s1">&#39;power-on&#39;</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span> <span class="o">&amp;&amp;</span> <span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">pClass</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">pClass</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span> <span class="o">=</span> <span class="nx">bPower</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// cut power to other things, too</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">powerDialLED</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">bPower</span> <span class="o">?</span> <span class="mf">0.9</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setMotor</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">power_state</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">=</span> <span class="nx">bPower</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-94'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-94">&#182;</a>
        </div>
        <p>ramp up?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">applyPowerUpEffect</span><span class="p">();</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-95'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-95">&#182;</a>
        </div>
        <p>wind down?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">applyBrakeEffect</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">applyBrakeEffect</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span> <span class="c1">// long brake effect, if spinning</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setVelocity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nVelocity</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-96'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-96">&#182;</a>
        </div>
        <p>lock platter + record speeds</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="nx">nVelocity</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-97'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-97">&#182;</a>
        </div>
        <p>record will play catch-up, unless platter lock is on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocityOffset</span> <span class="o">=</span> <span class="p">((</span><span class="o">!</span><span class="nx">STRICT_MODE</span> <span class="o">||</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">locked</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">));</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyVelocity</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nVelocity</span><span class="p">,</span> <span class="nx">bIgnoreIfNotMoving</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">isHTML5</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-98'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-98">&#182;</a>
        </div>
        <p>console.log(&lsquo;velocity: &rsquo;+nVelocity);
hard-limit velocity</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">nVelocity</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nVelocity</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">nVelocity</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">nVelocity</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">nVelocity</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">bIgnoreIfNotMoving</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// don&#39;t let slider controls etc. start sound again</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">applyRate</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">,</span> <span class="nx">nVelocity</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyBrakeEffect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bPower</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">timer</span><span class="p">,</span>
        <span class="nx">recordRate</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">,</span>
        <span class="nx">brakeMultiplier</span> <span class="o">=</span> <span class="p">(</span><span class="nx">bPower</span> <span class="o">?</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">longBrakeMultiplier</span> <span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">shortBrakeMultiplier</span><span class="p">);</span>

    <span class="kd">function</span> <span class="nx">endEffect</span><span class="p">()</span> <span class="p">{</span>

      <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
      <span class="nx">timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">brakeEffect</span><span class="p">()</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">recordRate</span> <span class="o">*=</span> <span class="nx">brakeMultiplier</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nx">recordRate</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">recordRate</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.01</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
          <span class="nx">endEffect</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">endEffect</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">brakeEffect</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyPowerUpEffect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">timer</span><span class="p">,</span>
        <span class="nx">targetVelocity</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getPlatterVelocity</span><span class="p">(),</span>
        <span class="nx">recordRate</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">),</span> <span class="c1">// at least..</span>
        <span class="nx">powerUpMultiplier</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">powerUpMultiplier</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">powerUpEffect</span><span class="p">()</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">&lt;</span> <span class="nx">targetVelocity</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">recordRate</span> <span class="o">*=</span> <span class="nx">powerUpMultiplier</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">setVelocity</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">targetVelocity</span><span class="p">,</span> <span class="nx">recordRate</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-99'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-99">&#182;</a>
        </div>
        <p>we&rsquo;re done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nb">window</span><span class="p">.</span><span class="nx">clearInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">);</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">locked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">targetVelocity</span><span class="p">);</span>
        <span class="nx">timer</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">locked</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="nx">timer</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">powerUpEffect</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">togglePowerDial</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-100'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-100">&#182;</a>
        </div>
        <p>power has been switched completely on or off.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-101'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-101">&#182;</a>
        </div>
        <p>.. and the platter is spinning&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">sound</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span>

        <span class="p">}</span>

      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">setPower</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">setPower</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">toggleStartStop</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">isEmpty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-102'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-102">&#182;</a>
        </div>
        <p>need to start ze motor</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">isEmpty</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="nx">sound</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/null\.mp3/i</span><span class="p">));</span> <span class="c1">// special case: don&#39;t start empty turntable.</span>

        <span class="nx">isEmpty</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sound</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">sound</span><span class="p">.</span><span class="nx">togglePause</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-103'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-103">&#182;</a>
        </div>
        <p>if scratch_mode, speed up to 1 and resume?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">sound</span><span class="p">.</span><span class="nx">resume</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-104'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-104">&#182;</a>
        </div>
        <p>special case: sound loaded while power/motor was off</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>              <span class="nx">self</span><span class="p">.</span><span class="nx">startDynamicSound</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-105'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-105">&#182;</a>
        </div>
        <p>special case: scratch mode and new URL loaded over existing one, hasn&rsquo;t started playing yet..</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">isEmpty</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">playState</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-106'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-106">&#182;</a>
        </div>
        <p>ensure buffer is cool, and sound actually starts (if it&rsquo;s already loaded, from cache etc.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onbufferchange</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-107'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-107">&#182;</a>
        </div>
        <p>motor, possibly sound already running</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">sound</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-108'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-108">&#182;</a>
        </div>
        <p>edge case: new song loaded on already-playing record.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>            <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">applyVelocity</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">velocity</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmpty</span><span class="p">)</span> <span class="p">{</span>
              <span class="nx">sound</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
            <span class="p">}</span>
          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
          <span class="p">}</span>
        <span class="p">}</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">makeCuePoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">radialDistance</span><span class="p">,</span> <span class="nx">angle</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="p">(</span><span class="nx">cp</span> <span class="o">&amp;&amp;</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">node</span> <span class="o">?</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">node</span> <span class="o">:</span> <span class="kc">null</span><span class="p">),</span>
        <span class="nx">labelDiameter</span> <span class="o">=</span> <span class="mi">45</span><span class="p">,</span>
        <span class="nx">radialValue</span><span class="p">,</span>
        <span class="nx">cueRange</span><span class="p">,</span>
        <span class="nx">tonearmAngle</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">-</span> <span class="nx">self</span><span class="p">.</span><span class="nx">normalizeAngle</span><span class="p">(</span><span class="nx">angle</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-109'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-109">&#182;</a>
        </div>
        <p>trash and recreate&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">o</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

    <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;cuepoint&#39;</span><span class="p">;</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;tape&quot;&gt;&lt;/div&gt;&#39;</span><span class="p">;</span>

    <span class="nx">cueRange</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-</span> <span class="nx">labelDiameter</span><span class="p">;</span>
    <span class="nx">radialValue</span> <span class="o">=</span> <span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">radialDistance</span><span class="o">*</span><span class="nx">cueRange</span><span class="p">,</span> <span class="mi">10</span><span class="p">));</span>

    <span class="nx">o</span><span class="p">.</span><span class="nx">childNodes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">radialValue</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">tonearmAngle</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">makeMarker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">relativePosition</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">o</span> <span class="o">=</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">node</span> <span class="o">?</span> <span class="nx">m</span><span class="p">.</span><span class="nx">node</span> <span class="o">:</span> <span class="kc">null</span><span class="p">),</span>
        <span class="nx">label</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="s1">&#39;tt-2&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-110'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-110">&#182;</a>
        </div>
        <p>right deck is 6&hellip;0</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">label</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">label</span> <span class="o">===</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">label</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-111'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-111">&#182;</a>
        </div>
        <p>trash and recreate&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">o</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">o</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;div&#39;</span><span class="p">);</span>

    <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;marker&#39;</span><span class="p">;</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;div class=&quot;label&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">label</span> <span class="o">+</span> <span class="s1">&#39;&lt;/div&gt;&#39;</span><span class="p">;</span>

    <span class="nx">o</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">relativePosition</span> <span class="o">*</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">;</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveform2</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">o</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">o</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setCuePoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">positionOverride</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-112'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-112">&#182;</a>
        </div>
        <p>needs to have something loaded, at least&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>
        <span class="nx">sound</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">,</span>
        <span class="nx">cpAngle</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angle</span><span class="p">,</span>
        <span class="nx">cpNode</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">makeCuePoint</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span><span class="o">/</span><span class="nx">sound</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">,</span> <span class="nx">cpAngle</span><span class="p">),</span>
        <span class="nx">markerNode</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">makeMarker</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span><span class="o">/</span><span class="nx">sound</span><span class="p">.</span><span class="nx">durationEstimate</span><span class="p">);</span> <span class="c1">// related waveform marker</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">position</span><span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">positionOverride</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">positionOverride</span> <span class="o">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span>
      <span class="nx">angle</span><span class="o">:</span> <span class="nx">cpAngle</span><span class="p">,</span> <span class="c1">// - (d.record.dragging ? d.record.angleOffset : 0)</span>
      <span class="nx">node</span><span class="o">:</span> <span class="nx">cpNode</span>
    <span class="p">};</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">position</span><span class="o">:</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">positionOverride</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">positionOverride</span> <span class="o">:</span> <span class="nx">sound</span><span class="p">.</span><span class="nx">position</span><span class="p">),</span>
      <span class="nx">node</span><span class="o">:</span> <span class="nx">markerNode</span>
    <span class="p">};</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyCuePoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">cp</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-113'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-113">&#182;</a>
        </div>
        <p>if previously unused, then set it now.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">setCuePoint</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="nx">cp</span><span class="p">.</span><span class="nx">position</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">angle</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-114'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-114">&#182;</a>
        </div>
        <p>force refresh, if loaded</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">force_refresh</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">refresh</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">velocity</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-115'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-115">&#182;</a>
        </div>
        <p>.. and force the proper tonearm update, if need be</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">({</span>
          <span class="nx">position</span><span class="o">:</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">position</span>
        <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">destroyCuePoint</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">cp</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">cp</span> <span class="o">&amp;&amp;</span> <span class="nx">cp</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">cp</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">cp</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">destroyMarker</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span> <span class="c1">// get related marker, as well</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">destroyMarker</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">m</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">m</span> <span class="o">&amp;&amp;</span> <span class="nx">m</span><span class="p">.</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">m</span><span class="p">.</span><span class="nx">node</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">m</span><span class="p">.</span><span class="nx">node</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">.</span><span class="nx">markers</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">destroyCuePoints</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">destroyCuePoint</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">cuePoints</span> <span class="o">=</span> <span class="p">[];</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">startPlatterNudge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">direction</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudging</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudgeDirection</span> <span class="o">=</span> <span class="nx">direction</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">lastPitchValue</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span> <span class="c1">// store for eventual reset..</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyPlatterNudge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-116'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-116">&#182;</a>
        </div>
        <p>TODO: Ceiling on amount of nudge that can be applied.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">old</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">old</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">((</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudgeDirection</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">*</span><span class="mf">0.01</span><span class="o">*</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudgeDirection</span><span class="p">,</span> <span class="mi">10</span><span class="p">)));</span> <span class="c1">// add at least 1 (nudgeDirection)</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">movePitchSliderPerValue</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">));</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">stopPlatterNudge</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudging</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">lastPitchValue</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">();</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;resetting&#39;</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">movePitchSliderPerValue</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">lastPitchValue</span><span class="p">);</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
       <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;resetting&#39;</span><span class="p">);</span>
      <span class="p">},</span> <span class="mi">250</span><span class="p">);</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">platter</span><span class="p">.</span><span class="nx">nudging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">updateLoadProgress</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">bytesLoaded</span><span class="p">,</span> <span class="nx">bytesTotal</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">bytesLoaded</span> <span class="o">&amp;&amp;</span> <span class="nx">bytesTotal</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-117'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-117">&#182;</a>
        </div>
        <p>hide cover via w/h change and opacity. or something.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kd">var</span> <span class="nx">percentage</span> <span class="o">=</span> <span class="nx">bytesLoaded</span><span class="o">/</span><span class="nx">bytesTotal</span><span class="p">,</span>
          <span class="nx">percentageRemaining</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="nx">percentage</span><span class="p">,</span>
          <span class="nx">pixels</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">.</span><span class="nx">offsetWidth</span> <span class="o">*</span> <span class="nx">percentageRemaining</span><span class="p">);</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="nx">pixels</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginLeft</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">loader</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">marginTop</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">pixels</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">startDynamicSound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_startDynamicSound</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setBlockSize</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">nBlockSize</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_setBlockSize</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="p">,</span> <span class="nx">nBlockSize</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">stopEORSound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-118'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-118">&#182;</a>
        </div>
        <p>stop any existing ones</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSounds</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">playState</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">setPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">stop</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_stopDynamicSound</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">sID</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSound</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">startEORSound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSounds</span><span class="p">,</span>
    <span class="nx">sound</span> <span class="o">=</span> <span class="nx">s</span><span class="p">[</span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span><span class="o">*</span><span class="nx">s</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span> <span class="mi">10</span><span class="p">)];</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSound</span> <span class="o">=</span> <span class="nx">sound</span><span class="p">;</span>
    <span class="kd">function</span> <span class="nx">ready</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">eor</span><span class="p">.</span><span class="nx">onfinish</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">sound</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">sound</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">sound</span><span class="p">.</span><span class="nx">load</span><span class="p">({</span>
        <span class="nx">onload</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="nx">ready</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">ready</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">soundEvents</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">eor</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// end-of-record</span>

      <span class="nx">onfinish</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">this</span><span class="p">.</span><span class="nx">setPosition</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_startDynamicSound</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">sID</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">({</span>
          <span class="nx">onfinish</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">eor</span><span class="p">.</span><span class="nx">onfinish</span> <span class="c1">// self-referential...</span>
        <span class="p">});</span>
      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">whileloading</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">updateLoadProgress</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bytesLoaded</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bytesTotal</span><span class="p">);</span>

    <span class="p">},</span>

    <span class="nx">onload</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-119'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-119">&#182;</a>
        </div>
        <p>self.dom.artImage.style.opacity = 1;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">updateLoadProgress</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bytesLoaded</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">bytesTotal</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">startDynamicSound</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">onfinish</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-120'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-120">&#182;</a>
        </div>
        <p>fake-reset the sound to the end (SM2 normally resets to 0), and keep it active (but paused)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">this</span><span class="p">.</span><span class="nx">play</span><span class="p">({</span><span class="nx">position</span><span class="o">:</span><span class="k">this</span><span class="p">.</span><span class="nx">duration</span><span class="p">});</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pause</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-121'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-121">&#182;</a>
        </div>
        <p>and fake it, to be safe..</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">position</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">duration</span><span class="p">;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">moveTonearm</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-122'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-122">&#182;</a>
        </div>
        <p>and play the end-of-record noise</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">startEORSound</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">onplay</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">startTimer</span><span class="p">();</span>

    <span class="p">},</span>

    <span class="nx">onbufferchange</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">isBuffering</span> <span class="o">&amp;&amp;</span> <span class="nx">self</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="p">.</span><span class="nx">startDynamicSound</span><span class="p">();</span>
          <span class="p">}</span>
        <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">whileplaying</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-123'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-123">&#182;</a>
        </div>
        <p>console.log(&lsquo;sound id &rsquo;+this.sID+&lsquo; / position: &rsquo;+this.position+&lsquo;/&rsquo;+this.duration);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>
    
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">startTimer</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">timer</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">initSound</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span> <span class="o">=</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">createSound</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="s1">&#39;turntableSound&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">soundCounter</span><span class="o">++</span><span class="p">),</span>
      <span class="nx">url</span><span class="o">:</span> <span class="nx">sURL</span><span class="p">,</span>
      <span class="nx">whileloading</span><span class="o">:</span> <span class="p">(</span><span class="nx">IS_SPECIAL_SNOWFLAKE</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">whileloading</span><span class="p">),</span>
      <span class="nx">whileplaying</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">whileplaying</span><span class="p">,</span>
      <span class="nx">onfinish</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onfinish</span><span class="p">,</span>
      <span class="nx">onload</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onload</span><span class="p">,</span>
      <span class="nx">onplay</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onplay</span><span class="p">,</span>
      <span class="nx">onbufferchange</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onbufferchange</span>
    <span class="p">});</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSounds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">createSound</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="o">+</span><span class="s1">&#39;EORSound0&#39;</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;audio/endnoise-1.mp3&#39;</span><span class="p">,</span>
      <span class="nx">onfinish</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">eor</span><span class="p">.</span><span class="nx">onfinish</span>
    <span class="p">}));</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">eorSounds</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">createSound</span><span class="p">({</span>
      <span class="nx">id</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">sID</span><span class="o">+</span><span class="s1">&#39;EORSound1&#39;</span><span class="p">,</span>
      <span class="nx">url</span><span class="o">:</span> <span class="s1">&#39;audio/endnoise-2.mp3&#39;</span><span class="p">,</span>
      <span class="nx">onfinish</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">eor</span><span class="p">.</span><span class="nx">onfinish</span>
    <span class="p">}));</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">setBlockSize</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">blockSize</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;experimental&#39;</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s1">&#39;block&#39;</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-124'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-124">&#182;</a>
        </div>
        <p>local reference</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">sound</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-125'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-125">&#182;</a>
        </div>
        <p>kick things off</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">startTimer</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isTouchDevice</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearmImage</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">powerDial</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">togglePowerDial</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">startStop</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">toggleStartStop</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">resetPitch</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSliderInput</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">updatePitchThrottled</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">rpm33</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">setRPMClick</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">rpm45</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">setRPMClick</span><span class="p">);</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearmImage</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">tonearmMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pitchSlider</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">pitchMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">powerDial</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">togglePowerDial</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">startStop</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">toggleStartStop</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">recordMouseDown</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="s1">&#39;touchstart&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">waveformBoxMouseDown</span><span class="p">);</span>

  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-126'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-126">&#182;</a>
        </div>
        <p>fetch the record coords up-front</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">record</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">record</span><span class="p">);</span>

  <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">waveform</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">initSound</span><span class="p">();</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">setButtonRPM</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">setPower</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">Mixer</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-Mixer()'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Mixer()">&#182;</a>
        </div>
        <h2>Mixer()</h2>

<p>Imagine a Stanton SK-2f, with the buttery-smooth optical cross-fader.
&hellip; Or, a Rane TTM-54. Both have their merits.
        :D
|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|
|   o    o   |
|   o    o   |
|   o    o   |
|   +    +   |
|   |    |   |
|   &mdash;|&mdash;    |
|&mdash;&mdash;&mdash;&mdash;&mdash;&mdash;|</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">CrossFader</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">crossFader</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">input</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">crossFaderUI</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">crossFaderSlider</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">value</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// stored from input</span>
      <span class="nx">valueMax</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">lastValue</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span></pre></div>
      </td>
    </tr>
    <tr id='section-128'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-128">&#182;</a>
        </div>
        <p>special-case because we have two outputs here</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">outputValues</span><span class="o">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
      <span class="nx">crossFaderSlider</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">minX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">maxX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">lastX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">lastOffsetX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">mouseOffsetX</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="nx">crossFaderUI</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setDragging</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isDragging</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">utils</span><span class="p">[</span><span class="nx">isDragging</span><span class="o">?</span><span class="s1">&#39;addClass&#39;</span><span class="o">:</span><span class="s1">&#39;removeClass&#39;</span><span class="p">](</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">),</span>
          <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
          <span class="nx">mouseScale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1">// how far to move relative to mouse</span>
          <span class="nx">sliderX</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">lastX</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">lastOffsetX</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">mouseOffsetX</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">midWidth</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nx">mouseScale</span> <span class="p">),</span>
          <span class="nx">sliderPosition</span><span class="p">,</span>
          <span class="nx">sliderValue</span><span class="p">,</span>
          <span class="nx">sliderMax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">sliderMidpoint</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">sliderInputValue</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-129'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-129">&#182;</a>
        </div>
        <p>depending on event target, move <input> or CSS UI</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="nx">sliderX</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">,</span> <span class="nx">sliderX</span><span class="p">));</span>

      <span class="nx">sliderPosition</span> <span class="o">=</span> <span class="p">(</span><span class="nx">sliderX</span> <span class="o">/</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">maxX</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-130'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-130">&#182;</a>
        </div>
        <p>set position</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nx">sliderX</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>

      <span class="nx">sliderInputValue</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">sliderPosition</span> <span class="o">*</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-131'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-131">&#182;</a>
        </div>
        <p>update underlying node</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">sliderInputValue</span><span class="p">);</span> <span class="c1">// relative to input&#39;s min/max</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">sliderInputValue</span><span class="p">;</span> <span class="c1">// this one actually updates the UI.</span>

      <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-132'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-132">&#182;</a>
        </div>
        <p>may happen at ends?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-133'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-133">&#182;</a>
        </div>
        <p>update own data&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span> <span class="o">=</span> <span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">applyValue</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">applyValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">vol1</span><span class="p">,</span> <span class="nx">vol2</span><span class="p">,</span> <span class="nx">opacity</span><span class="p">,</span>
          <span class="nx">waveformOpacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// maximum opacity</span>
          <span class="nx">opacityDelta</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>  <span class="c1">// max amount to subtract</span>
          <span class="nx">waveformOpacityDelta</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">vol1</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">-</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="nx">value</span><span class="o">-</span><span class="mi">50</span><span class="p">)</span><span class="o">/</span><span class="mi">50</span><span class="p">);</span>
        <span class="nx">vol2</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="nx">opacity</span> <span class="o">=</span> <span class="nx">opacityDelta</span><span class="o">-</span><span class="p">((</span><span class="nx">vol1</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="nx">opacityDelta</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-134'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-134">&#182;</a>
        </div>
        <p>turntable opacity effects</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;rgba(0,0,0,&#39;</span><span class="o">+</span><span class="nx">opacity</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span> <span class="o">-</span> <span class="p">(</span><span class="nx">opacity</span><span class="o">/</span><span class="nx">opacityDelta</span> <span class="o">*</span> <span class="p">(</span><span class="nx">waveformOpacity</span> <span class="o">*</span> <span class="nx">waveformOpacityDelta</span><span class="p">));</span> <span class="c1">// todo: refactor</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">===</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">vol1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="nx">vol2</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-135'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-135">&#182;</a>
        </div>
        <p>reset opacity effects</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span><span class="p">;</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="nx">vol1</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
        <span class="nx">vol2</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="nx">value</span><span class="o">/</span><span class="mi">50</span><span class="p">;</span>
        <span class="nx">opacity</span> <span class="o">=</span> <span class="nx">opacityDelta</span><span class="o">-</span><span class="p">((</span><span class="nx">vol2</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="nx">opacityDelta</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-136'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-136">&#182;</a>
        </div>
        <p>turntable opacity effects</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;transparent&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">cover</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;rgba(0,0,0,&#39;</span><span class="o">+</span><span class="nx">opacity</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
        <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">waveformBox</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">waveformOpacity</span> <span class="o">-</span> <span class="p">(</span><span class="nx">opacity</span><span class="o">/</span><span class="nx">opacityDelta</span> <span class="o">*</span> <span class="p">(</span><span class="nx">waveformOpacity</span> <span class="o">*</span> <span class="nx">waveformOpacityDelta</span><span class="p">));</span> <span class="c1">// todo: refactor</span>

      <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-137'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-137">&#182;</a>
        </div>
        <p>update own data&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vol1</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValues</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">vol2</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-138'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-138">&#182;</a>
        </div>
        <p>&hellip; and update mixer</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setValue</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-139'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-139">&#182;</a>
        </div>
        <p>update input&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// actually updates the UI</span></pre></div>
      </td>
    </tr>
    <tr id='section-140'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-140">&#182;</a>
        </div>
        <p>move element&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">left</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">*</span><span class="p">(</span><span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;px&#39;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-141'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-141">&#182;</a>
        </div>
        <p>&hellip;and apply</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">applyValue</span><span class="p">(</span><span class="nx">value</span><span class="p">);</span> 

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-142'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-142">&#182;</a>
        </div>
        <p>update crossfader, and mixer</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">assignEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">xFader</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span>
          <span class="nx">xFaderSlider</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">;</span>

      <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">xFader</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">xFaderSlider</span><span class="p">,</span> <span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">reset</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-143'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-143">&#182;</a>
        </div>
        <p>container + fader</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderUI</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.crossfader-ui&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// ?</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.crossfader-slider&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// ?</span></pre></div>
      </td>
    </tr>
    <tr id='section-144'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-144">&#182;</a>
        </div>
        <p>get fader + input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFader</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span> <span class="c1">// TODO: Review this. Right element?</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-145'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-145">&#182;</a>
        </div>
        <p>read from input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">valueMax</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-146'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-146">&#182;</a>
        </div>
        <p>read from DOM</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">);</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">);</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">minX</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">maxX</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">midWidth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">midWidth</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">maxX</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">;</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">assignEvents</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-147'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-147">&#182;</a>
        </div>
        <p>fire onchange/update event, to refresh live logic?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">};</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

  <span class="p">}</span> <span class="c1">// CrossFader();</span>


  <span class="kd">function</span> <span class="nx">UpFader</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">initCallback</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">upFaderBox</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// container</span>
      <span class="nx">upFaderUI</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// CSS UI</span>
      <span class="nx">input</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">value</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="c1">// stored from input</span>
      <span class="nx">valueMax</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">upFaderBox</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span>
      <span class="p">},</span>
      <span class="nx">upFaderUI</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">offsetTop</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetLeft</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetWidth</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">offsetHeight</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midX</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">midY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">minY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">maxY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">lastY</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
        <span class="nx">lastOffsetY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="nx">mouseOffsetY</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">},</span>
      <span class="nx">turntableIndex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">turntableId</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">outputValue</span><span class="o">:</span> <span class="mi">1</span> <span class="c1">// read and applied directly to sound</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setDragging</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isDragging</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">utils</span><span class="p">[</span><span class="nx">isDragging</span><span class="o">?</span><span class="s1">&#39;addClass&#39;</span><span class="o">:</span><span class="s1">&#39;removeClass&#39;</span><span class="p">](</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-148'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-148">&#182;</a>
        </div>
        <p>depending on event target, move <input> or CSS UI</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kd">var</span> <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="kd">var</span> <span class="nx">mouseScale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1">// how far to move relative to mouse</span>
          <span class="nx">sliderY</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastY</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastOffsetY</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">mouseOffsetY</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="nx">mouseScale</span> <span class="p">),</span>
          <span class="nx">sliderPosition</span><span class="p">,</span>
          <span class="nx">sliderValue</span><span class="p">,</span>
          <span class="nx">sliderMax</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
          <span class="nx">sliderMidpoint</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
          <span class="nx">sliderInputValue</span><span class="p">;</span>

      <span class="nx">sliderY</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">minY</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">midHeight</span> <span class="o">-</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">sliderY</span><span class="p">));</span> <span class="c1">// enforce limits</span>

      <span class="nx">sliderPosition</span> <span class="o">=</span> <span class="p">((</span><span class="nx">sliderY</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">midHeight</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">-</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">offsetHeight</span> <span class="o">-</span> <span class="mi">3</span><span class="p">));</span></pre></div>
      </td>
    </tr>
    <tr id='section-149'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-149">&#182;</a>
        </div>
        <p>set position</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="nx">sliderY</span> <span class="o">+</span> <span class="s1">&#39;px&#39;</span><span class="p">;</span>

      <span class="nx">sliderInputValue</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">sliderPosition</span> <span class="o">*</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)),</span> <span class="mi">10</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-150'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-150">&#182;</a>
        </div>
        <p>update underlying node</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="nx">sliderInputValue</span><span class="p">);</span> <span class="c1">// relative to input&#39;s min/max</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="nx">sliderInputValue</span><span class="p">);</span> <span class="c1">// actually updates the UI</span>

      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">value</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-151'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-151">&#182;</a>
        </div>
        <p>may happen at ends?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-152'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-152">&#182;</a>
        </div>
        <p>update own data&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span> <span class="o">=</span> <span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-153'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-153">&#182;</a>
        </div>
        <p>&hellip; and update mixer</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span> <span class="c1">// default volume</span></pre></div>
      </td>
    </tr>
    <tr id='section-154'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-154">&#182;</a>
        </div>
        <p>TODO: Use default from better place</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span> <span class="c1">// actually updates the UI</span></pre></div>
      </td>
    </tr>
    <tr id='section-155'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-155">&#182;</a>
        </div>
        <p>update own data&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span> <span class="o">=</span> <span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-156'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-156">&#182;</a>
        </div>
        <p>update UI&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">top</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="o">-</span><span class="nx">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-157'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-157">&#182;</a>
        </div>
        <p>&hellip; and update mixer</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">self</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-158'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-158">&#182;</a>
        </div>
        <p>that.update(e);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">assignEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">upFader</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">,</span>
          <span class="nx">upFaderUI</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">;</span>

      <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">upFader</span><span class="p">,</span> <span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">update</span><span class="p">);</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">upFaderUI</span><span class="p">,</span> <span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">reset</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">UPFADER_DEFAULT</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">;</span> <span class="c1">// eg., 25%</span></pre></div>
      </td>
    </tr>
    <tr id='section-159'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-159">&#182;</a>
        </div>
        <p>get fader + input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderBox</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.upfader-slider&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-160'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-160">&#182;</a>
        </div>
        <p>read from input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">valueMax</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-161'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-161">&#182;</a>
        </div>
        <p>turntable references</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableIndex</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-table-id&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableId</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;turntableSound&#39;</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableIndex</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-162'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-162">&#182;</a>
        </div>
        <p>box measurements</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">offsetWidth</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">getCoordsForDOM</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">);</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">minY</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">midHeight</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastY</span> <span class="o">=</span> <span class="p">(</span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="o">*</span><span class="nx">UPFADER_DEFAULT</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">);</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">midHeight</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">maxY</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">offsetHeight</span><span class="p">;</span>

      <span class="p">}</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">assignEvents</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-163'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-163">&#182;</a>
        </div>
        <p>feed back to the parent for storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">initCallback</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderBox</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">));</span>

  <span class="p">}</span> <span class="c1">// UpFader();</span>


  <span class="kd">function</span> <span class="nx">Pot</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">initCallback</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-164'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-164">&#182;</a>
        </div>
        <p>uh-huh huh huh. heh heh, m-heh. he said, &ldquo;pot.&rdquo; (As in, potentiometer.)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">that</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">mixer</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">pot</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">input</span><span class="o">:</span> <span class="kc">null</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">angle</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">angleMin</span><span class="o">:</span> <span class="o">-</span><span class="mi">150</span><span class="p">,</span>
      <span class="nx">angleMax</span><span class="o">:</span> <span class="mi">150</span><span class="p">,</span>
      <span class="nx">value</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// real value from input, etc.</span>
      <span class="nx">outputValue</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="c1">// value that is referenced/used eg., volume control etc.</span>
      <span class="nx">valueMax</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetLeft</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetTop</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetWidth</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">offsetHeight</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">midX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">midY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">mouseX</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">mouseY</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="nx">turntableIndex</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">turntableId</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">instance</span><span class="o">:</span> <span class="p">{}</span> <span class="c1">// type-specific data (eg., EQ offset)</span>
    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">methods</span> <span class="o">=</span> <span class="p">{</span>

      <span class="nx">eq</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-165'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-165">&#182;</a>
        </div>
        <p>TODO: lowest value should never be 0.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="kd">var</span> <span class="nx">outValue</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mf">1.5</span><span class="p">);</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span> <span class="o">=</span> <span class="nx">outValue</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_setEQ</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableId</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">dataEQOffset</span><span class="p">,</span> <span class="nx">outValue</span><span class="p">);</span>
        <span class="p">}</span>

      <span class="p">},</span>

      <span class="nx">eqSetup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">instance</span><span class="p">.</span><span class="nx">dataEQOffset</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-eq-offset&#39;</span><span class="p">);</span>

      <span class="p">},</span>

      <span class="nx">gain</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">gain</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">tt</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">[</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableIndex</span><span class="p">],</span>
            <span class="nx">outValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>

        <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span> <span class="o">=</span> <span class="nx">outValue</span><span class="p">;</span>

        <span class="nx">tt</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">gain</span> <span class="o">=</span> <span class="nx">outValue</span><span class="p">;</span>

        <span class="nx">mixer</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span>

      <span class="p">},</span>

      <span class="nx">gainSetup</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-166'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-166">&#182;</a>
        </div>
        <p>console.log(&lsquo;gainSetup()&rsquo;);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">}</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">methodTypeMap</span> <span class="o">=</span> <span class="p">{</span> <span class="c1">// keyed on data-type attribute</span>

      <span class="nx">eq</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">applyEQ</span><span class="p">,</span>
      <span class="nx">gain</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">applyGain</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// mapped to the above, depending</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setMethod</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-167'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-167">&#182;</a>
        </div>
        <p>console.log(&lsquo;setMethod(&rsquo;+type+&lsquo;)&rsquo;);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">method</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="nx">type</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-168'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-168">&#182;</a>
        </div>
        <p>apply the setup method, which may configure some things</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kd">var</span> <span class="nx">setup</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">methods</span><span class="p">[</span><span class="nx">type</span><span class="o">+</span><span class="s1">&#39;Setup&#39;</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">setup</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">setup</span><span class="p">();</span>
      <span class="p">}</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">reset</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">applyAngle</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">applyEffect</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">applyAngle</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">angle</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="nx">d</span><span class="p">.</span><span class="nx">angle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">angleMax</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">angleMin</span><span class="p">,</span> <span class="nx">angle</span><span class="p">));</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pot</span><span class="p">,</span> <span class="nx">d</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span> <span class="c1">// haaaack</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">applyEffect</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-169'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-169">&#182;</a>
        </div>
        <p>eg. angle from -150 to +150, make it one sweep from 0-100%</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">valueMax</span> <span class="o">*</span> <span class="p">((</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">angleMax</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">angleMax</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-170'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-170">&#182;</a>
        </div>
        <p>update the hidden element and ish</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span> <span class="c1">// actually updates the UI</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">method</span><span class="p">();</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">setDragging</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">isDragging</span><span class="p">)</span> <span class="p">{</span>

      <span class="nx">utils</span><span class="p">[</span><span class="nx">isDragging</span><span class="o">?</span><span class="s1">&#39;addClass&#39;</span><span class="o">:</span><span class="s1">&#39;removeClass&#39;</span><span class="p">](</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pot</span><span class="p">,</span> <span class="s1">&#39;dragging&#39;</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-171'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-171">&#182;</a>
        </div>
        <p>get pot + input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pot</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">getElementsByClassName</span><span class="p">(</span><span class="s1">&#39;pot&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span></pre></div>
      </td>
    </tr>
    <tr id='section-172'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-172">&#182;</a>
        </div>
        <p>read from input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">valueMax</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">);</span>
      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableIndex</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-table-id&#39;</span><span class="p">),</span> <span class="mi">10</span><span class="p">);</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">turntableId</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;turntableSound&#39;</span> <span class="o">+</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-table-id&#39;</span><span class="p">));</span>

      <span class="nx">that</span><span class="p">.</span><span class="nx">setMethod</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-type&#39;</span><span class="p">));</span>

      <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pot</span><span class="p">,</span> <span class="s1">&#39;dblclick&#39;</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">reset</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-173'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-173">&#182;</a>
        </div>
        <p>feed back to the parent for storage</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">initCallback</span><span class="p">(</span><span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">pot</span><span class="p">);</span>

    <span class="p">};</span>

    <span class="nx">that</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

  <span class="p">}</span> <span class="c1">// Pot();</span></pre></div>
      </td>
    </tr>
    <tr id='section-174'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-174">&#182;</a>
        </div>
        <p>Mixer() &hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">this</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">pots</span><span class="o">:</span> <span class="p">[],</span>      <span class="c1">// gain and eq</span>
    <span class="nx">potsById</span><span class="o">:</span> <span class="p">{},</span>  <span class="c1">// for lookups from mouseDown event</span>
    <span class="nx">upFaders</span><span class="o">:</span> <span class="p">[],</span>  <span class="c1">// [0] and [1]</span>
    <span class="nx">upFadersById</span><span class="o">:</span> <span class="p">{},</span>
    <span class="nx">crossFader</span><span class="o">:</span> <span class="p">{}</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">dom</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">events</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">dragTarget</span><span class="o">:</span> <span class="kc">null</span><span class="p">,</span> <span class="c1">// convenient reference for events</span>

    <span class="nx">mouseDown</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">,</span>
          <span class="nx">o</span><span class="p">,</span> <span class="nx">relObj</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
      <span class="p">}</span>

      <span class="nx">o</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-175'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-175">&#182;</a>
        </div>
        <p>scrollbar clicked, or some other nonsense</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="kd">function</span> <span class="nx">stop</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">dragTarget</span> <span class="o">=</span> <span class="nx">o</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-176'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-176">&#182;</a>
        </div>
        <p>for now: target element class name determines the control we&rsquo;re working with.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;pot&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// eh, brittle for now.</span></pre></div>
      </td>
    </tr>
    <tr id='section-177'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-177">&#182;</a>
        </div>
        <p>grab current coordinates, find out which pot etc.?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">potsById</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">id</span><span class="p">];</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mouseX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mouseY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">pot</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">pot</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">stop</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;upfader-cover&#39;</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;control-upfader&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// CSS UI vs. &lt;input&gt;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFadersById</span><span class="p">[</span><span class="nx">o</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-id&#39;</span><span class="p">)];</span>

        <span class="nx">relObj</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-178'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-178">&#182;</a>
        </div>
        <p>offset things</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">mouseY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastY</span> <span class="o">=</span> <span class="p">(</span><span class="nx">relObj</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">offsetTop</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">minY</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastOffsetY</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">findXY</span><span class="p">(</span><span class="nx">relObj</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">mouseOffsetY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaderUI</span><span class="p">.</span><span class="nx">lastOffsetY</span><span class="p">;</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">upFader</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">upFader</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">stop</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;crossfader-cover&#39;</span> <span class="o">||</span> <span class="nx">o</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="s1">&#39;control-crossfader&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// CSS UI vs. &lt;input&gt;</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">;</span>

        <span class="nx">relObj</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-179'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-179">&#182;</a>
        </div>
        <p>offset things</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderUI</span><span class="p">.</span><span class="nx">mouseX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">lastX</span> <span class="o">=</span> <span class="p">(</span><span class="nx">relObj</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">offsetLeft</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">minX</span><span class="p">;</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">lastOffsetX</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">findXY</span><span class="p">(</span><span class="nx">relObj</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">mouseOffsetX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">relObj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFaderSlider</span><span class="p">.</span><span class="nx">lastOffsetX</span><span class="p">;</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

        <span class="nx">relObj</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">stop</span><span class="p">();</span>

      <span class="p">}</span>
      
    <span class="p">},</span>

    <span class="nx">crossFader</span><span class="o">:</span> <span class="p">{</span>

      <span class="nx">mouseMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

      <span class="p">},</span>

      <span class="nx">mouseUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">pot</span><span class="o">:</span> <span class="p">{</span>

      <span class="nx">mouseMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">,</span>
            <span class="nx">eOriginal</span> <span class="o">=</span> <span class="nx">e</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">isTouchDevice</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">e</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="kd">var</span> <span class="nx">yDiff</span> <span class="o">=</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mouseY</span> <span class="o">-</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">);</span>

        <span class="nx">o</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">angle</span> <span class="o">+=</span> <span class="mi">180</span><span class="o">*</span><span class="p">(</span><span class="nx">yDiff</span><span class="o">/</span><span class="mi">20</span><span class="p">);</span> <span class="c1">// haaaack</span>

        <span class="nx">o</span><span class="p">.</span><span class="nx">applyAngle</span><span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">angle</span><span class="p">);</span>

        <span class="nx">o</span><span class="p">.</span><span class="nx">applyEffect</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-180'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-180">&#182;</a>
        </div>
        <p>and update ze mouse</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">o</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mouseX</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientX</span><span class="p">;</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">mouseY</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">clientY</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">eOriginal</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

      <span class="p">},</span>

      <span class="nx">mouseUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>

        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">pot</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">pot</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

      <span class="p">}</span>

    <span class="p">},</span>

    <span class="nx">upFader</span><span class="o">:</span> <span class="p">{</span>

      <span class="nx">mouseMove</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">;</span>

        <span class="nx">o</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span>

      <span class="p">},</span>

      <span class="nx">mouseUp</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

        <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">relatedObject</span><span class="p">.</span><span class="nx">setDragging</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
        
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">upFader</span><span class="p">.</span><span class="nx">mouseMove</span><span class="p">);</span>
        <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">upFader</span><span class="p">.</span><span class="nx">mouseUp</span><span class="p">);</span>

      <span class="p">}</span>

    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">getVolumeForChannel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">channel</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-181'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-181">&#182;</a>
        </div>
        <p>output volume = input volume &ndash;&gt; gain &ndash;&gt; upfader &ndash;&gt; crossfader</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-182'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-182">&#182;</a>
        </div>
        <p>potentially-dangerous: assumes gain is [0] and [1] of pots array</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">gain</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pots</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span><span class="p">,</span>
      <span class="nx">upFader</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaders</span><span class="p">[</span><span class="nx">channel</span><span class="p">].</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValue</span><span class="p">,</span>
      <span class="nx">crossFader</span><span class="o">:</span> <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">outputValues</span><span class="p">[</span><span class="nx">channel</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">gain</span> <span class="o">*</span> <span class="nx">data</span><span class="p">.</span><span class="nx">upFader</span> <span class="o">*</span> <span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span> <span class="o">*</span> <span class="mi">100</span><span class="p">;</span> <span class="c1">// 0-1 scaled by 100%</span>

    <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">applyVolume</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
   </pre></div>
      </td>
    </tr>
    <tr id='section-183'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-183">&#182;</a>
        </div>
        <p>get volume from mixer outputs, apply to sounds</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">v0</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getVolumeForChannel</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="nx">v1</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">getVolumeForChannel</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
        <span class="nx">tt0</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="nx">tts0</span> <span class="o">=</span> <span class="nx">tt0</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">,</span>
        <span class="nx">tt1</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="nx">tts1</span> <span class="o">=</span> <span class="nx">tt1</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">;</span>

    <span class="nx">tts0</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">setVolume</span><span class="p">(</span><span class="nx">v0</span><span class="p">);</span>
    <span class="nx">tts1</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">setVolume</span><span class="p">(</span><span class="nx">v1</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-184'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-184">&#182;</a>
        </div>
        <p>affect end-of-record sounds, too</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">tts0</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tts0</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">.</span><span class="nx">setVolume</span><span class="p">(</span><span class="nx">v0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">tts1</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">tts1</span><span class="p">.</span><span class="nx">eorSound</span><span class="p">.</span><span class="nx">setVolume</span><span class="p">(</span><span class="nx">v1</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">assignEvents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-185'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-185">&#182;</a>
        </div>
        <p>delegates for click. If on .pot, then watch mousemove/up.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">mixer</span><span class="p">,</span> <span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">mouseDown</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-186'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-186">&#182;</a>
        </div>
        <p>TODO: refactor</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;use-eq&#39;</span><span class="p">).</span><span class="nx">checked</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">self</span><span class="p">.</span><span class="nx">eqEnabled</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;use-eq&#39;</span><span class="p">).</span><span class="nx">checked</span><span class="p">;</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;use-eq&#39;</span><span class="p">),</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">eqEnabled</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;use-eq&#39;</span><span class="p">).</span><span class="nx">checked</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">eqEnabled</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_enableEQ</span><span class="p">(</span><span class="s1">&#39;turntableSound0&#39;</span><span class="p">);</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_enableEQ</span><span class="p">(</span><span class="s1">&#39;turntableSound1&#39;</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_disableEQ</span><span class="p">(</span><span class="s1">&#39;turntableSound0&#39;</span><span class="p">);</span>
          <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_disableEQ</span><span class="p">(</span><span class="s1">&#39;turntableSound1&#39;</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">createPots</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">oContainers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">mixer</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;li&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">potMade</span><span class="p">(</span><span class="nx">oPot</span><span class="p">,</span> <span class="nx">oDomNode</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">potsById</span><span class="p">[</span><span class="nx">oDomNode</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oPot</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="nx">oContainers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">pots</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Pot</span><span class="p">(</span><span class="nx">oContainers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">potMade</span><span class="p">));</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">createUpFaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">oContainers</span> <span class="o">=</span> <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">mixer</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;div.upfader&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">;</span>

    <span class="kd">function</span> <span class="nx">upFaderMade</span><span class="p">(</span><span class="nx">oUpFader</span><span class="p">,</span> <span class="nx">faderID</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFadersById</span><span class="p">[</span><span class="nx">faderID</span><span class="p">]</span> <span class="o">=</span> <span class="nx">oUpFader</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nx">j</span><span class="o">=</span><span class="nx">oContainers</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">j</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">upFaders</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">UpFader</span><span class="p">(</span><span class="nx">oContainers</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">upFaderMade</span><span class="p">));</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">createCrossFader</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CrossFader</span><span class="p">(</span><span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">mixer</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.x-fader-panel&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-187'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-187">&#182;</a>
        </div>
        <p>power on?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">self</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">mixer</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;mixer&#39;</span><span class="p">);</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">createPots</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">createUpFaders</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">createCrossFader</span><span class="p">();</span>

    <span class="nx">self</span><span class="p">.</span><span class="nx">assignEvents</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="nx">self</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

<span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-Main_initialization'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Main_initialization">&#182;</a>
        </div>
        <h2>Main initialization</h2>

<p>Hook off of soundManager.onready()
Create turntables + mixer objects, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">soundManager</span><span class="p">.</span><span class="nx">onready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">supported</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-189'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-189">&#182;</a>
        </div>
        <p>additional scratch mode check &ndash; if you don&rsquo;t have flash, then it must be false.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">&amp;&amp;</span> <span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">SCRATCH_MODE</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">oTT</span><span class="p">,</span>
      <span class="nx">html</span> <span class="o">=</span> <span class="p">[],</span>
      <span class="nx">i</span><span class="p">,</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span>
      <span class="nx">lastTarget</span> <span class="o">=</span> <span class="kc">null</span><span class="p">,</span>
      <span class="nx">url</span><span class="p">,</span>
      <span class="nx">urls</span><span class="p">,</span>
      <span class="nx">thruYou</span><span class="p">,</span>
      <span class="nx">rnd</span><span class="p">,</span>
      <span class="nx">loaderForm</span> <span class="o">=</span> <span class="p">[</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;loader-form-1&#39;</span><span class="p">),</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;loader-form-2&#39;</span><span class="p">)],</span>
      <span class="nx">urlParams</span><span class="p">,</span>
      <span class="nx">keyData</span><span class="p">,</span>
      <span class="nx">sc</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;soundcloud-tracks&#39;</span><span class="p">),</span>
      <span class="nx">sc_cache</span> <span class="o">=</span> <span class="p">{},</span>
      <span class="nx">loadURL</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">loadScript</span><span class="p">(</span><span class="nx">sURL</span><span class="p">,</span><span class="nx">onLoad</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">function</span> <span class="nx">loadScriptHandler</span><span class="p">()</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">rs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">readyState</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">rs</span> <span class="o">===</span> <span class="s1">&#39;loaded&#39;</span> <span class="o">||</span> <span class="nx">rs</span> <span class="o">===</span> <span class="s1">&#39;complete&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">onLoad</span><span class="p">)</span> <span class="p">{</span>
          <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">onLoad</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">scriptOnload</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">onLoad</span><span class="p">,</span><span class="mi">20</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">try</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">oS</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
      <span class="nx">oS</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="s1">&#39;text/javascript&#39;</span><span class="p">;</span>
      <span class="nx">oS</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;async&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">onLoad</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">oS</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="nx">loadScriptHandler</span><span class="p">;</span>
        <span class="nx">oS</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">scriptOnload</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="nx">oS</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">sURL</span><span class="p">;</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">oS</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-190'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-190">&#182;</a>
        </div>
        <p>oh well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getSoundcloudTopTen</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">soundcloudTopTen</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;utils/soundcloud_hot_tracks/&#39;</span><span class="p">;</span>
    <span class="nx">loadScript</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getSoundcloudSet</span><span class="p">(</span><span class="nx">set_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">wheelsofsteel</span><span class="p">[</span><span class="s1">&#39;soundcloudSet_&#39;</span><span class="o">+</span><span class="nx">set_id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">callback</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-191'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-191">&#182;</a>
        </div>
        <p>http://api.soundcloud.com/playlists/737966.json</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;utils/soundcloud_fetch_set/?id=&#39;</span> <span class="o">+</span> <span class="nx">set_id</span><span class="p">;</span>
    <span class="nx">loadScript</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">sc_cache_data</span><span class="p">(</span><span class="nx">scData</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">id</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">scData</span> <span class="o">&amp;&amp;</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">streamable</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">id</span> <span class="o">=</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
      <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">scData</span><span class="p">;</span>
      <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">wheelsofsteel</span> <span class="o">=</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-192'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-192">&#182;</a>
        </div>
        <p>should approximate &lsquo;http://api.soundcloud.com/tracks/&rsquo; + id + &lsquo;/stream?client<em>id=&rsquo; + ZOMG</em>SECRET
url: scData.stream<em>url + &lsquo;?client</em>id=&rsquo; + ZOMG_SECRET</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">};</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">fetchSoundcloudURL</span><span class="p">(</span><span class="nx">track_id</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">wheelsofsteel</span><span class="p">[</span><span class="s1">&#39;soundcloudURL_&#39;</span><span class="o">+</span><span class="nx">track_id</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scData</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">callback</span><span class="p">(</span><span class="nx">scData</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="nx">loadScript</span><span class="p">(</span><span class="s1">&#39;utils/soundcloud_fetch_url/?id=&#39;</span> <span class="o">+</span> <span class="nx">track_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){});</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">sc_callback</span><span class="p">(</span><span class="nx">scData</span><span class="p">,</span> <span class="nx">turntable</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">sc_cache_data</span><span class="p">(</span><span class="nx">scData</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">scData</span> <span class="o">&amp;&amp;</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">streamable</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">fetchSoundcloudURL</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scData</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="nx">loadURL</span><span class="p">(</span><span class="nx">sc_cache</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">turntable</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span> <span class="c1">// left vs. right-click</span>
      <span class="p">});</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">loadSoundcloudID</span><span class="p">(</span><span class="nx">track_id</span><span class="p">,</span> <span class="nx">oOptions</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">turntable</span> <span class="o">=</span> <span class="p">(</span><span class="nx">oOptions</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">turntable</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">oOptions</span><span class="p">.</span><span class="nx">turntable</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">track_id</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-193'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-193">&#182;</a>
        </div>
        <p>fetch API data
expose this SC callback</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">wheelsofsteel</span><span class="p">[</span><span class="s1">&#39;soundcloudJSONP_&#39;</span><span class="o">+</span><span class="nx">track_id</span><span class="p">]</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scData</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sc_callback</span><span class="p">(</span><span class="nx">scData</span><span class="p">,</span> <span class="nx">turntable</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oOptions</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">oOptions</span><span class="p">.</span><span class="nx">callback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">};</span>
      <span class="nx">loadScript</span><span class="p">(</span><span class="s1">&#39;utils/soundcloud_fetch_track/?id=&#39;</span> <span class="o">+</span> <span class="nx">track_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){});</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-194'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-194">&#182;</a>
        </div>
        <p>we&rsquo;ve already got the info.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">fetchSoundcloudURL</span><span class="p">(</span><span class="nx">track_id</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scData</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">track_id</span><span class="p">].</span><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">scData</span><span class="p">.</span><span class="nx">url</span><span class="p">;</span>
        <span class="nx">loadURL</span><span class="p">(</span><span class="nx">sc_cache</span><span class="p">[</span><span class="nx">track_id</span><span class="p">].</span><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span> <span class="nx">turntable</span><span class="p">,</span> <span class="nx">track_id</span><span class="p">);</span> <span class="c1">// left vs. right-click</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">oOptions</span><span class="p">.</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">oOptions</span><span class="p">.</span><span class="nx">callback</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-195'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-195">&#182;</a>
        </div>
        <p>loadURL(sc<em>cache[track</em>id].wheelsofsteel.url, turntable, track_id); // left vs. right-click</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">getURLState</span><span class="p">(</span><span class="nx">additional_params</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">winloc</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">,</span>
        <span class="nx">winURL</span> <span class="o">=</span> <span class="nx">winloc</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
        <span class="nx">urlState</span><span class="p">,</span> <span class="nx">url_params</span><span class="p">,</span> <span class="nx">track1</span><span class="p">,</span> <span class="nx">track2</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">params</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="nx">url_params</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getURLParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">track1</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;track1&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">track2</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;track2&#39;</span><span class="p">).</span><span class="nx">value</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">track1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">url_params</span><span class="p">.</span><span class="nx">track1</span> <span class="o">=</span> <span class="nx">track1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">track2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">url_params</span><span class="p">.</span><span class="nx">track2</span> <span class="o">=</span> <span class="nx">track2</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-196'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-196">&#182;</a>
        </div>
        <p>reconstruct URL, excluding a few things</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">delete</span> <span class="nx">url_params</span><span class="p">.</span><span class="nx">debug</span><span class="p">;</span>
    <span class="k">delete</span> <span class="nx">url_params</span><span class="p">.</span><span class="nx">scratch</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">additional_params</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-197'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-197">&#182;</a>
        </div>
        <p>eg. scratch=1</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">for</span> <span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">additional_params</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">additional_params</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span>
          <span class="nx">url_params</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span> <span class="o">=</span> <span class="nx">additional_params</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">toString</span><span class="p">();</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">url_params</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">url_params</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">item</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-198'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-198">&#182;</a>
        </div>
        <p>add URL, trimming local paths if applicable</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">params</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span> <span class="o">+</span> <span class="s1">&#39;=&#39;</span> <span class="o">+</span> <span class="nx">url_params</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">replace</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span><span class="o">+</span><span class="s1">&#39;//&#39;</span><span class="o">+</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">urlState</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s1">&#39;//&#39;</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">params</span><span class="p">.</span><span class="nx">length</span> <span class="o">?</span> <span class="s1">&#39;?&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&amp;&#39;</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="nx">winloc</span><span class="p">.</span><span class="nx">search</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span><span class="p">));</span> <span class="c1">// + (window.location.hash || &#39;&#39;);</span>

    <span class="k">return</span> <span class="nx">urlState</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">updateHistory</span><span class="p">()</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-199'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-199">&#182;</a>
        </div>
        <p>as user loads new tracks, update window location.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">historyURL</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">history</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">historyURL</span> <span class="o">=</span> <span class="nx">getURLState</span><span class="p">();</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">historyURL</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-200'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-200">&#182;</a>
        </div>
        <p>expose to global for a few things</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">getURLState</span> <span class="o">=</span> <span class="nx">getURLState</span><span class="p">;</span>

  <span class="kd">function</span> <span class="nx">unload</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">turntables</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">unload</span><span class="p">();</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;track&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)).</span><span class="nx">value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="nx">updateHistory</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">loadURL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sURL</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">soundcloudID</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">sURL</span> <span class="o">===</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">||</span> <span class="o">!</span><span class="nx">sURL</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">turntable</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span>
        <span class="nx">s</span> <span class="o">=</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">,</span>
        <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">window</span><span class="p">.</span><span class="nx">Image</span><span class="p">(),</span>
        <span class="nx">oInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;track&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span>
        <span class="nx">isSoundcloud</span> <span class="o">=</span> <span class="p">(</span><span class="nx">soundcloudID</span> <span class="o">||</span> <span class="nx">sURL</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^sc\-/i</span><span class="p">));</span> <span class="c1">// numeric ID, or sc-###### in URL</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">isSoundcloud</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">soundcloudID</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-201'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-201">&#182;</a>
        </div>
        <p>retrive from URL, trimming prefix</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">soundcloudID</span> <span class="o">=</span> <span class="nx">sURL</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-202'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-202">&#182;</a>
        </div>
        <p>go get the real URL based on ID, and load it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">loadSoundcloudID</span><span class="p">(</span><span class="nx">soundcloudID</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">turntable</span><span class="o">:</span> <span class="nx">i</span>
      <span class="p">});</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-203'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-203">&#182;</a>
        </div>
        <p>turntable.data.sound.soundObject.mute();</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">s</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-204'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-204">&#182;</a>
        </div>
        <p>manually reset the tonearm</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">turntable</span><span class="p">.</span><span class="nx">setAngle</span><span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">tonearm</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">css</span><span class="p">.</span><span class="nx">hasRecord</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-205'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-205">&#182;</a>
        </div>
        <p>go get the waveform stuff, if we&rsquo;re loading from the same place</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSoundcloud</span> <span class="o">&amp;&amp;</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">isSameProtocol</span><span class="p">(</span><span class="nx">sURL</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">turntable</span><span class="p">.</span><span class="nx">loadWaveform</span><span class="p">(</span><span class="nx">sURL</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">sURL</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;.mp3&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">turntable</span><span class="p">.</span><span class="nx">unloadWaveform</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-206'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-206">&#182;</a>
        </div>
        <p>waveforms: not yet.
turntable.loadWaveform(null, soundcloudID, sc<em>cache[soundcloudID].waveform</em>url);</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-207'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-207">&#182;</a>
        </div>
        <p>and apply to the relevant input</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">oInput</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">oInput</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="p">(</span><span class="nx">isSoundcloud</span> <span class="o">?</span> <span class="s1">&#39;sc-&#39;</span> <span class="o">+</span> <span class="nx">soundcloudID</span> <span class="o">:</span> <span class="nx">sURL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span> <span class="o">&amp;&amp;</span> <span class="nx">IS_SPECIAL_SNOWFLAKE</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-208'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-208">&#182;</a>
        </div>
        <p>iOS won&rsquo;t let the new sound automatically start, so kill the power.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntable</span><span class="p">.</span><span class="nx">setMotor</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">readyState</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-209'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-209">&#182;</a>
        </div>
        <p>stop eor sounds</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntable</span><span class="p">.</span><span class="nx">stopEORSound</span><span class="p">();</span>

      <span class="nx">s</span><span class="p">.</span><span class="nx">load</span><span class="p">({</span>
        <span class="nx">url</span><span class="o">:</span> <span class="nx">sURL</span><span class="p">,</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;audio/mp3&#39;</span> <span class="c1">// assumed</span>
      <span class="p">});</span>

      <span class="nx">turntable</span><span class="p">.</span><span class="nx">setBlockSize</span><span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">blockSize</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-210'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-210">&#182;</a>
        </div>
        <p>reset cue points&hellip;</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntable</span><span class="p">.</span><span class="nx">destroyCuePoints</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-211'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-211">&#182;</a>
        </div>
        <p>&hellip;and pitch</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntable</span><span class="p">.</span><span class="nx">updatePitch</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">table</span> <span class="o">&amp;&amp;</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">power</span><span class="p">.</span><span class="nx">motor</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-212'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-212">&#182;</a>
        </div>
        <p>and the motor is running..</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">s</span><span class="p">.</span><span class="nx">play</span><span class="p">({</span>
          <span class="nx">whileloading</span><span class="o">:</span> <span class="p">(</span><span class="nx">IS_SPECIAL_SNOWFLAKE</span> <span class="o">?</span> <span class="kc">null</span> <span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">whileloading</span><span class="p">),</span>
          <span class="nx">whileplaying</span><span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">whileplaying</span><span class="p">,</span>
          <span class="nx">onfinish</span><span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onfinish</span><span class="p">,</span>
          <span class="nx">onload</span><span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onload</span><span class="p">,</span>
          <span class="nx">onplay</span><span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onplay</span><span class="p">,</span>
          <span class="nx">onbufferchange</span><span class="o">:</span> <span class="nx">turntable</span><span class="p">.</span><span class="nx">soundEvents</span><span class="p">.</span><span class="nx">onbufferchange</span>
        <span class="p">});</span></pre></div>
      </td>
    </tr>
    <tr id='section-213'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-213">&#182;</a>
        </div>
        <p>volume, too.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">mixer</span><span class="p">.</span><span class="nx">applyVolume</span><span class="p">();</span>

      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

      <span class="nx">turntable</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">sound</span><span class="p">.</span><span class="nx">soundObject</span><span class="p">.</span><span class="nx">_iO</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">sURL</span><span class="p">;</span>

    <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-214'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-214">&#182;</a>
        </div>
        <p>and if applicable, rewrite history.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">updateHistory</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-215'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-215">&#182;</a>
        </div>
        <p>load, and do things if it succeeds / fails</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundImage</span> <span class="o">=</span> <span class="s1">&#39;url(&#39;</span><span class="o">+</span><span class="k">this</span><span class="p">.</span><span class="nx">src</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">;</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">,</span> <span class="s1">&#39;empty&#39;</span><span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">EMPTY_GIF</span><span class="p">;</span>
      <span class="nx">img</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="nx">img</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">EMPTY_GIF</span><span class="p">;</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">,</span> <span class="s1">&#39;empty&#39;</span><span class="p">);</span>
      <span class="nx">turntable</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">artImage</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">backgroundImage</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
      <span class="nx">img</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

    <span class="p">};</span></pre></div>
      </td>
    </tr>
    <tr id='section-216'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-216">&#182;</a>
        </div>
        <p>and attempt to load album art, if applicable.
this is a really dumb hackish way to do it, but it works for this demo.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isSoundcloud</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">sURL</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/nyanyanyan/i</span><span class="p">))</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-217'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-217">&#182;</a>
        </div>
        <p>special case. :D</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;tunes/nyancat-poptart1red1-by-prguitarman-dot-com.gif&#39;</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;tunes/&#39;</span><span class="o">+</span><span class="nx">sURL</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">sURL</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;.mp3&#39;</span><span class="p">,</span><span class="s1">&#39;.jpg&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-218'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-218">&#182;</a>
        </div>
        <p>w00t</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">if</span> <span class="p">(</span><span class="nx">sc_cache</span><span class="p">[</span><span class="nx">soundcloudID</span><span class="p">].</span><span class="nx">artwork_url</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">sc_cache</span><span class="p">[</span><span class="nx">soundcloudID</span><span class="p">].</span><span class="nx">artwork_url</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;large&#39;</span><span class="p">,</span><span class="s1">&#39;crop&#39;</span><span class="p">);</span> <span class="c1">// http://developers.soundcloud.com/docs/api/tracks#artwork_url</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">EMPTY_GIF</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">handleLoaderSubmit</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
        <span class="nx">input</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="c1">// the URL element</span>
        <span class="nx">id</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nx">input</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="c1">// array ID is zero-based</span>
        <span class="nx">url</span> <span class="o">=</span> <span class="nx">input</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="nx">loadURL</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">id</span><span class="p">);</span> 
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">input</span><span class="p">.</span><span class="nx">blur</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">ee</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-219'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-219">&#182;</a>
        </div>
        <p>oh well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handleLoaderFocus</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s1">&#39;focused&#39;</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">handleLoaderBlur</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">,</span> <span class="s1">&#39;focused&#39;</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">toggleDebug</span><span class="p">()</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">debugCSS</span> <span class="o">=</span> <span class="s1">&#39;debug&#39;</span><span class="p">,</span>
        <span class="nx">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">turntables</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
      <span class="nx">utils</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">dom</span><span class="p">.</span><span class="nx">table</span><span class="p">,</span> <span class="nx">debugCSS</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">toggleClass</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;mixer&#39;</span><span class="p">),</span> <span class="nx">debugCSS</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="nx">nTT</span><span class="p">,</span> <span class="nx">nCue</span><span class="p">,</span> <span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">t</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">[</span><span class="nx">nTT</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">setCuePoint</span><span class="p">(</span><span class="nx">nCue</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">destroyCuePoint</span><span class="p">(</span><span class="nx">nCue</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">t</span><span class="p">.</span><span class="nx">applyCuePoint</span><span class="p">(</span><span class="nx">nCue</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keyIsDown</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">o</span> <span class="o">=</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">!==</span> <span class="s1">&#39;undefined&#39;</span> <span class="o">?</span> <span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">:</span> <span class="kc">null</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">o</span> <span class="o">&amp;&amp;</span> <span class="nx">o</span><span class="p">.</span><span class="nx">isDown</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">o</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>
      <span class="p">}</span>
      <span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">isDown</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keyReset</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="p">{</span>
      <span class="nx">keyData</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">isDown</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">safeForKeys</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">return</span> <span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">||</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/input/i</span><span class="p">)));</span>

  <span class="p">}</span>

  <span class="nx">oTT</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tt-container&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">oTT</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">className</span><span class="p">;</span>
    <span class="nx">oTT</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="p">(</span><span class="nx">oTT</span><span class="p">.</span><span class="nx">className</span> <span class="o">?</span> <span class="nx">oTT</span><span class="p">.</span><span class="nx">className</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">SCRATCH_MODE</span> <span class="o">?</span> <span class="s1">&#39;scratch-mode&#39;</span> <span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nx">turntables</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Turntable</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tt-1&#39;</span><span class="p">)));</span>
  <span class="nx">turntables</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Turntable</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tt-2&#39;</span><span class="p">)));</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-220'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-220">&#182;</a>
        </div>
        <p>URL loader form events. TODO: Clean-up</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="nx">handleLoaderSubmit</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">unload</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;focus&#39;</span><span class="p">,</span> <span class="nx">handleLoaderFocus</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="nx">handleLoaderBlur</span><span class="p">);</span>
    <span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">onblur</span> <span class="o">=</span> <span class="nx">handleLoaderBlur</span><span class="p">;</span>

    <span class="nx">loaderForm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">onsubmit</span> <span class="o">=</span> <span class="nx">handleLoaderSubmit</span><span class="p">;</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">unload</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;focus&#39;</span><span class="p">,</span> <span class="nx">handleLoaderFocus</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;input&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="nx">handleLoaderBlur</span><span class="p">);</span>

  <span class="p">}</span>

  <span class="nx">o</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;the-music&#39;</span><span class="p">);</span>

  <span class="nx">o</span><span class="p">.</span><span class="nx">onmousedown</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-221'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-221">&#182;</a>
        </div>
        <p>a link may have been clicked. sort out which, and which turntable to load it on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;span&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">utils</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;exclude&#39;</span><span class="p">))</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">lastTarget</span> <span class="o">&amp;&amp;</span> <span class="nx">lastTarget</span> <span class="o">!==</span> <span class="nx">target</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lastTarget</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="nx">target</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span><span class="p">;</span>
      <span class="nx">lastTarget</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>

        <span class="kd">var</span> <span class="nx">track_id</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;data-track-id&#39;</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">track_id</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-222'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-222">&#182;</a>
        </div>
        <p>regular MP3</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">loadURL</span><span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span> <span class="c1">// left vs. right-click</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
          <span class="p">}</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-223'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-223">&#182;</a>
        </div>
        <p>soundcloud</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">);</span>
          <span class="nx">loadSoundcloudID</span><span class="p">(</span><span class="nx">track_id</span><span class="p">,</span> <span class="p">{</span>
            <span class="nx">turntable</span><span class="o">:</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">ctrlKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">altKey</span> <span class="o">||</span> <span class="nx">e</span><span class="p">.</span><span class="nx">metaKey</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
            <span class="nx">callback</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
              <span class="nx">utils</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;loading&#39;</span><span class="p">);</span>
            <span class="p">}</span>
          <span class="p">});</span>

        <span class="p">}</span>

      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

    <span class="p">}</span>

  <span class="p">};</span>

  <span class="nx">o</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;span&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">target</span> <span class="o">=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">target</span><span class="p">.</span><span class="nx">nodeName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span> <span class="o">===</span> <span class="s1">&#39;a&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">utils</span><span class="p">.</span><span class="nx">hasClass</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="s1">&#39;exclude&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">sc</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">getSoundcloudTopTen</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">topten</span> <span class="o">=</span> <span class="p">[];</span>
      <span class="k">for</span> <span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">streamable</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">sc_cache_data</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">]);</span>
          <span class="nx">topten</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sc_cache</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">id</span><span class="p">]);</span>
        <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">topten</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">topten</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">items</span> <span class="o">=</span> <span class="nx">topten</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">);</span> <span class="c1">// artist - name where possible</span>
          <span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;#&quot; data-track-id=&quot;&#39;</span><span class="o">+</span><span class="nx">topten</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot; oncontextmenu=&quot;return false&quot;&gt;&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">2</span> <span class="o">?</span> <span class="s1">&#39;&lt;span style=&quot;font-weight:normal;color:rgba(255,255,255,0.5)&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; - &lt;/span&gt;&#39;</span> <span class="o">+</span> <span class="nx">items</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="nx">topten</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;soundcloud-top10&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;ul&gt;&#39;</span> <span class="o">+</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/ul&gt;&#39;</span><span class="p">;</span>
      <span class="p">}</span>

    <span class="p">});</span>

    <span class="k">if</span> <span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;soundcloud-beastieboys&#39;</span><span class="p">))</span> <span class="p">{</span>

      <span class="nx">getSoundcloudSet</span><span class="p">(</span><span class="mi">737966</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">bboys</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">streamable</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-224'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-224">&#182;</a>
        </div>
        <p>playlist is cool to stream
TODO: Store meta info</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>          <span class="nx">data</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">tracks</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="p">(</span><span class="nx">item</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">streamable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">sc_cache_data</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">]);</span>
            <span class="nx">bboys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">sc_cache</span><span class="p">[</span><span class="nx">data</span><span class="p">[</span><span class="nx">item</span><span class="p">].</span><span class="nx">id</span><span class="p">]);</span>
          <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">bboys</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[];</span>
          <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">bboys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&lt;a href=&quot;#&quot; data-track-id=&quot;&#39;</span><span class="o">+</span><span class="nx">bboys</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">id</span><span class="o">+</span><span class="s1">&#39;&quot; oncontextmenu=&quot;return false&quot;&gt;&#39;</span> <span class="o">+</span> <span class="nx">bboys</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">title</span> <span class="o">+</span> <span class="s1">&#39;&lt;/a&gt;&lt;/li&gt;&#39;</span><span class="p">);</span>
          <span class="p">}</span>
          <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;soundcloud-beastieboys&#39;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s1">&#39;&lt;ol&gt;&#39;</span> <span class="o">+</span> <span class="nx">tmp</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&lt;/ol&gt;&#39;</span><span class="p">;</span>
        <span class="p">}</span>

      <span class="p">});</span>

    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">moreinfo_link</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;moreinfo-link&#39;</span><span class="p">);</span>

  <span class="nx">moreinfo_link</span><span class="p">.</span><span class="nx">onclick</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">controls</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;controls&#39;</span><span class="p">),</span>
    <span class="nx">css_open</span> <span class="o">=</span> <span class="s1">&#39;open&#39;</span><span class="p">,</span>
    <span class="nx">was_open</span> <span class="o">=</span> <span class="nx">controls</span><span class="p">.</span><span class="nx">className</span> <span class="o">===</span> <span class="nx">css_open</span><span class="p">;</span>
    <span class="nx">controls</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="p">(</span><span class="nx">was_open</span> <span class="o">?</span> <span class="s1">&#39;&#39;</span> <span class="o">:</span> <span class="nx">css_open</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">was_open</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-225'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-225">&#182;</a>
        </div>
        <p>toggle-based effect</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">=</span> <span class="s1">&#39;#less&#39;</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">if</span> <span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span> <span class="o">&amp;&amp;</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">hash</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/more/i</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;controls&#39;</span><span class="p">).</span><span class="nx">className</span> <span class="o">!==</span> <span class="s1">&#39;open&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-226'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-226">&#182;</a>
        </div>
        <p>toggle things open</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">moreinfo_link</span><span class="p">.</span><span class="nx">onclick</span><span class="p">();</span>

  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-227'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-227">&#182;</a>
        </div>
        <p>assign key handlers</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">keyData</span> <span class="o">=</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-228'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-228">&#182;</a>
        </div>
        <p>structure assigned dynamically
eg.
&lsquo;]&rsquo; : { isDown: false} </p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="p">};</span></pre></div>
      </td>
    </tr>
    <tr id='section-229'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-229">&#182;</a>
        </div>
        <p>Would love to use DOM3 keyLocation to determine left/right-ness
of keys like shift + ctrl, but this doesn&rsquo;t seem to be
implemented as of may 2011. http://unixpapa.com/js/key.html
IE implements shiftLeft / shiftRight, but nobody else does.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">keyDownActions</span> <span class="o">=</span> <span class="p">{</span>

    <span class="s1">&#39;16&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// shift key(s)</span>
    <span class="p">},</span>
    <span class="s1">&#39;37&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// left arrow</span>
      <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;39&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// right arrow</span>
      <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;38&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// up arrow</span>
      <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;40&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// down arrow</span>
      <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;49&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 1</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;50&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;51&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;52&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;53&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;54&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;55&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;56&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;57&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 9</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;48&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 0</span>
      <span class="nx">editOrApplyCue</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="nx">e</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;66&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// b</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">toggleBattleMode</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;68&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">toggleDebug</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;83&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// s</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">shiftKey</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">nextSkin</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">keyPressActions</span> <span class="o">=</span> <span class="p">{</span>

    <span class="s1">&#39;-&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">startPlatterNudge</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;=&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">startPlatterNudge</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;_&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">startPlatterNudge</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;+&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">startPlatterNudge</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">},</span>
    <span class="s1">&#39;[&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">keyIsDown</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
        <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-230'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-230">&#182;</a>
        </div>
        <p>mixer.data.crossFader.update();</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;]&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">keyIsDown</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">=</span> <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">dom</span><span class="p">.</span><span class="nx">input</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">);</span>
        <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span></pre></div>
      </td>
    </tr>
    <tr id='section-231'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-231">&#182;</a>
        </div>
        <p>mixer.data.crossFader.update();</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;,&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// &lt; sans-shift</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toggleStartStop</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;.&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// &gt; sans-shift</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">toggleStartStop</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;&lt;&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">togglePowerDial</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;&gt;&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">togglePowerDial</span><span class="p">();</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">keyUpActions</span> <span class="o">=</span> <span class="p">{</span>

    <span class="s1">&#39;16&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// shift key(s)</span>
    <span class="p">},</span>
    <span class="s1">&#39;189&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// -</span></pre></div>
      </td>
    </tr>
    <tr id='section-232'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-232">&#182;</a>
        </div>
        <p>shift may or may not be on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">stopPlatterNudge</span><span class="p">();</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">stopPlatterNudge</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;187&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// +</span></pre></div>
      </td>
    </tr>
    <tr id='section-233'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-233">&#182;</a>
        </div>
        <p>shift may or may not be on.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">stopPlatterNudge</span><span class="p">();</span>
      <span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">stopPlatterNudge</span><span class="p">();</span>
    <span class="p">},</span>
    <span class="s1">&#39;219&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// [</span>
      <span class="nx">keyReset</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span><span class="p">;</span>
          <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">last</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;221&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// ]</span>
      <span class="nx">keyReset</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span> <span class="o">!==</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">last</span> <span class="o">=</span> <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">lastValue</span><span class="p">;</span>
          <span class="nx">mixer</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">crossFader</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">last</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">keyHandlerDown</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-234'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-234">&#182;</a>
        </div>
        <p>TODO: Handle repeated events when keys repeatedly fire?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">if</span> <span class="p">(</span><span class="nx">keyDownActions</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">safeForKeys</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">keyDownActions</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">](</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keyHandlerPress</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="kr">char</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">charCode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">keyPressActions</span><span class="p">[</span><span class="kr">char</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">safeForKeys</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">keyPressActions</span><span class="p">[</span><span class="kr">char</span><span class="p">](</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">keyHandlerUp</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">keyUpActions</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">safeForKeys</span><span class="p">(</span><span class="nx">e</span><span class="p">))</span> <span class="p">{</span>
      <span class="nx">keyUpActions</span><span class="p">[</span><span class="nx">e</span><span class="p">.</span><span class="nx">keyCode</span><span class="p">](</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">shareOnTwitter</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tweetURL</span> <span class="o">=</span> <span class="s1">&#39;http://twitter.com/share?text=%s&#39;</span><span class="p">,</span>
        <span class="nx">tweetMessage</span> <span class="o">=</span> <span class="s1">&#39;DJing from my browser on the &quot;Wheels Of Steel&quot; prototype:&#39;</span><span class="p">;</span>

    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">tweetURL</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;%s&#39;</span><span class="p">,</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">tweetMessage</span><span class="p">)),</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;width=800,height=400&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">shareOnFacebook</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">fbURL</span> <span class="o">=</span> <span class="s1">&#39;http://www.facebook.com/sharer.php?t=%title&amp;u=%url&#39;</span><span class="p">,</span>
        <span class="nx">message</span> <span class="o">=</span> <span class="s1">&#39;DJing from my browser on the Wheels Of Steel prototype&#39;</span><span class="p">,</span>
        <span class="nx">shareURL</span> <span class="o">=</span> <span class="nx">fbURL</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;%title&#39;</span><span class="p">,</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">message</span><span class="p">)).</span><span class="nx">replace</span><span class="p">(</span><span class="s1">&#39;%url&#39;</span><span class="p">,</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">toString</span><span class="p">()));</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="nx">shareURL</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;width=1000,height=600&#39;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">e</span> <span class="o">&amp;&amp;</span> <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">urlParamsObj</span> <span class="o">=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">getURLParams</span><span class="p">(</span><span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">search</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">debug</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">toggleDebug</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">tripmat</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">),</span> <span class="s1">&#39;tripmat&#39;</span><span class="p">);</span>
    <span class="nx">utils</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">turntables</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">id</span><span class="p">),</span> <span class="s1">&#39;tripmat&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">skin</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">try</span> <span class="p">{</span>
      <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">setSkin</span><span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">skin</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-235'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-235">&#182;</a>
        </div>
        <p>d'oh well</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="p">}</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-236'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-236">&#182;</a>
        </div>
        <p>set/refresh scratch mode preference</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">utils</span><span class="p">.</span><span class="nx">storage</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s1">&#39;prefs&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;scratchMode&#39;</span><span class="o">:</span> <span class="nx">SCRATCH_MODE</span>
  <span class="p">});</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">loaderForm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span> <span class="c1">// form is present...</span></pre></div>
      </td>
    </tr>
    <tr id='section-237'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-237">&#182;</a>
        </div>
        <p>look for tracks to load</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kd">var</span> <span class="nx">item</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">track1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">loadURL</span><span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">track1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">track2</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">loadURL</span><span class="p">(</span><span class="nx">urlParamsObj</span><span class="p">.</span><span class="nx">track2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-238'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-238">&#182;</a>
        </div>
        <p>expose to global</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">shareOnTwitter</span> <span class="o">=</span> <span class="nx">shareOnTwitter</span><span class="p">;</span>
  <span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">shareOnFacebook</span> <span class="o">=</span> <span class="nx">shareOnFacebook</span><span class="p">;</span>

  <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="nx">keyHandlerDown</span><span class="p">);</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;keypress&#39;</span><span class="p">,</span> <span class="nx">keyHandlerPress</span><span class="p">);</span>
  <span class="nx">utils</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="s1">&#39;keyup&#39;</span><span class="p">,</span> <span class="nx">keyHandlerUp</span><span class="p">);</span>

  <span class="nx">mixer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mixer</span><span class="p">();</span></pre></div>
      </td>
    </tr>
    <tr id='section-239'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-239">&#182;</a>
        </div>
        <p>debug-mode only?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="nx">timer</span><span class="p">.</span><span class="nx">debugStats</span><span class="p">();</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">setInterval</span><span class="p">(</span><span class="nx">timer</span><span class="p">.</span><span class="nx">debugStats</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

<span class="p">});</span>

<span class="nb">window</span><span class="p">.</span><span class="nx">setEQ</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">turntableID</span><span class="p">,</span> <span class="nx">eqIndex</span><span class="p">,</span> <span class="nx">eqInput</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">ttID</span> <span class="o">=</span> <span class="s1">&#39;turntableSound&#39;</span><span class="o">+</span><span class="nx">turntableID</span><span class="p">,</span>
      <span class="nx">value</span> <span class="o">=</span> <span class="nx">eqInput</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span>
      <span class="nx">max</span> <span class="o">=</span> <span class="nx">eqInput</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">),</span>
      <span class="nx">mid</span> <span class="o">=</span> <span class="nx">max</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>
      <span class="nx">relativeValue</span><span class="p">,</span>
      <span class="nx">outValue</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">value</span> <span class="o">&gt;=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">relativeValue</span> <span class="o">=</span> <span class="nx">value</span><span class="o">/</span><span class="nx">max</span><span class="p">;</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="nx">relativeValue</span> <span class="o">=</span> <span class="p">(</span><span class="nx">mid</span> <span class="o">-</span> <span class="p">(</span><span class="nx">mid</span> <span class="o">*</span> <span class="p">(</span><span class="nx">mid</span><span class="o">-</span><span class="nx">value</span><span class="p">)</span><span class="o">/</span><span class="nx">mid</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">relativeValue</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// wtf?</span>
      <span class="nx">relativeValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">relativeValue</span> <span class="o">&gt;=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">outValue</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="p">((</span><span class="nx">relativeValue</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">);</span>

  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

    <span class="nx">outValue</span> <span class="o">=</span> <span class="nx">relativeValue</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_setEQ</span><span class="p">(</span><span class="nx">ttID</span><span class="p">,</span> <span class="nx">eqIndex</span><span class="p">,</span> <span class="nx">outValue</span><span class="p">);</span>
  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-240'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-240">&#182;</a>
        </div>
        <p>enable or disable if all values are centered</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span>
      <span class="nx">inputs</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;tt-&#39;</span><span class="o">+</span><span class="p">(</span><span class="nx">turntableID</span><span class="o">+</span><span class="mi">1</span><span class="p">)).</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.control-eq&#39;</span><span class="p">),</span>
      <span class="nx">isSet</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">inputs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">inputs</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span> <span class="o">!==</span> <span class="nx">mid</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">isSet</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">soundManager</span><span class="p">.</span><span class="nx">html5Only</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">isSet</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_enableEQ</span><span class="p">(</span><span class="nx">ttID</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">soundManager</span><span class="p">.</span><span class="nx">o</span><span class="p">.</span><span class="nx">_disableEQ</span><span class="p">(</span><span class="nx">ttID</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="p">};</span>

<span class="kd">function</span> <span class="nx">setBattleMode</span><span class="p">(</span><span class="nx">bOn</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">sClass</span> <span class="o">=</span> <span class="s1">&#39;battle-style&#39;</span><span class="p">,</span>
      <span class="nx">oElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">oElement</span> <span class="o">&amp;&amp;</span> <span class="nx">BATTLE_MODE</span> <span class="o">!==</span> <span class="nx">bOn</span><span class="p">)</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-241'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-241">&#182;</a>
        </div>
        <p>we&rsquo;re shifting.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="nx">utils</span><span class="p">[(</span><span class="nx">bOn</span> <span class="o">?</span> <span class="s1">&#39;addClass&#39;</span> <span class="o">:</span> <span class="s1">&#39;removeClass&#39;</span><span class="p">)](</span><span class="nx">oElement</span><span class="p">,</span> <span class="nx">sClass</span><span class="p">);</span>

    <span class="nx">BATTLE_MODE</span> <span class="o">=</span> <span class="nx">bOn</span><span class="p">;</span>

  <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-242'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-242">&#182;</a>
        </div>
        <p>invalidate DOM position data (since rotation will affect box model, need to re-get width/height etc.)
this is incomplete.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="cm">/*</span>
<span class="cm">  turntables[0].data.record.offsetWidth = null;</span>
<span class="cm">  turntables[0].data.tonearm.offsetWidth = null;</span>

<span class="cm">  turntables[1].data.record.offsetWidth = null;</span>
<span class="cm">  turntables[1].data.tonearm.offsetWidth = null;</span>
<span class="cm">  */</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">toggleBattleMode</span><span class="p">()</span> <span class="p">{</span>

  <span class="nx">setBattleMode</span><span class="p">(</span><span class="o">!</span><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">getBattleMode</span><span class="p">());</span>

<span class="p">}</span>

<span class="kd">function</span> <span class="nx">getBattleMode</span><span class="p">()</span> <span class="p">{</span>

  <span class="k">return</span> <span class="nx">BATTLE_MODE</span><span class="p">;</span>

<span class="p">}</span>

<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">setBattleMode</span> <span class="o">=</span> <span class="nx">setBattleMode</span><span class="p">;</span>
<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">getBattleMode</span> <span class="o">=</span> <span class="nx">getBattleMode</span><span class="p">;</span>
<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">toggleBattleMode</span> <span class="o">=</span> <span class="nx">toggleBattleMode</span><span class="p">;</span></pre></div>
      </td>
    </tr>
    <tr id='section-243'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-243">&#182;</a>
        </div>
        <p>skin/theme bits</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="kd">var</span> <span class="nx">skins</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;yahoo&#39;</span><span class="p">,</span><span class="s1">&#39;flickr&#39;</span><span class="p">],</span>
    <span class="nx">currentSkin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">setSkin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">sName</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">skin</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="nx">skins</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span><span class="p">;)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">skins</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="nx">sName</span><span class="p">)</span> <span class="p">{</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;has_js&#39;</span><span class="p">,</span> <span class="nx">skins</span><span class="p">[</span><span class="nx">i</span><span class="p">]].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
      <span class="nx">currentSkin</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span>

<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">nextSkin</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">currentSkin</span><span class="o">++</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">currentSkin</span> <span class="o">&gt;=</span> <span class="nx">skins</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currentSkin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;has_js&#39;</span><span class="p">,</span> <span class="nx">skins</span><span class="p">[</span><span class="nx">currentSkin</span><span class="p">]].</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
  <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
  <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">};</span></pre></div>
      </td>
    </tr>
    <tr id='section-244'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-244">&#182;</a>
        </div>
        <p>expose instances to the window.wheelsofsteel global</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">mixer</span> <span class="o">=</span> <span class="nx">mixer</span><span class="p">;</span>
<span class="nx">wheelsofsteel</span><span class="p">.</span><span class="nx">turntables</span> <span class="o">=</span> <span class="nx">turntables</span><span class="p">;</span>

<span class="p">}(</span><span class="nb">window</span><span class="p">));</span> <span class="c1">// invocation</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
